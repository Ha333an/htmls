<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Encrypted page</title>
</head>
<body>
  <div>
    <input id="pw" type="password" placeholder="Enter password">
    <button id="btn" onclick="attemptUnlock()">Unlock</button>
  </div>
  <div id="status"></div>
  <div id="content" style="display:none"></div>

<script>
const tokenB64 = "5Detvdr5yJgsPxlFBLxvI_fIIpzROkXJjzVjoLh6AEabq2YOxPkropM_a6OU-9CuauOHfOHjM56E0m1uoEmnTv9WJeTcjAckr5XbLEy7aPtiKmIiFap_gzh8gEVdi8EX9IX6v6dRYEOdyD2rYmN6KNg4cUnhLp8sbffFayMAKWJ3IoHsnTiz3SEdCvozzS-DsaKotrrKiOgFOs87vZIF6nqaMFHNnZDHDbTEhLrl6FRXvpYKAKLk8ar7dO1NhlQZf4iS7FQyVZNVFSP6weAHYO2030Fhcj0qU9N18stsbWEKYb1rUvNCLzxuf0OZAVzHZjiwESSs1U6ITr8bvfysWIv_Q2PQTBbBr7lWrxq2Uv7wJEDPlWI7NmKs75uOFEsWUAXXwxuEF9mf4v3x0I_4dJr4neP2FwBNguS7Tne3-fvMSG6OameFPi2OZGPJSaw_AflFn0j9ybkSBv1vpaH-DAISra3OPTLrfRnJKEo4wIXqolNXPKxXTOV4RHvG0TrbiezOH9W0zMmI_yvl_mHgvCeL4ZxC_vOdbjZJBo8HEfoKan6stiWFXRDg2wZmIsPxMdGQ4vjWE88Owj4KmWK9Gq98OZBbSfJNbuZcaiXcV_uQrhoR4YG-rXWb6bHifHYCXB3KELduLBVIN1nEQ43zMEjJbR_VvX6x7sASJDrr-yODJBYaQzulPLEZxpzLUS0cTDf32P4cW8B4XJDaJOYMOQxZoBB-5xSx-Ubnx8CuBxrkgFFXKTys7xxkio-X7hzWVW3H_63aCDEajD_LV8j4zXwU4ZJCysOre0QuE1ABfo53zVrMsI_Fq_pZQRRFVVqLdfqCDNsO60Z8OiWEApXx4LHHTvuC0zA2OlV3F5-U3KyBnoGEes7RE74UHsHvS_UlbRutm55GQqH_aByKl9QFeBENUlSfiXVBXDn0vcD5OaJyn_Jk5kNns8F500gUUHzHlhDJdhs5tM6nUOGRAAzLufDNmQFC3LFTNpIAmdzpr7uYD83twtZyGbWq0YvSHg_qiRTlzAvAVQ6pD2_XIYUrC6B3HrM69VE66FjxaNFMhimhxWPT3XOMAnD9xg7CVvHF-WX8h-ZKbtHSdTPPNmDOmF7jYM2AGSabSHwGuI07DdDr08tC12UZZGCFdQQzDnX0rRKEpa3YMC0hWxzmkuJ5kPwm0wTfOdLxdGhG5YDbOW60ofh4OQtdGe6sspitSxoFlS5ILpH_bqIG7VmVVdlql0d5DX4D63WhT7AQaP9zawU2tdW4yJZlM-rtTf200mKnMPj9Se1TZha5amUfYuVkE8Igk1JIMsKevqwB7v3tpyaZSfYHn7uvnA_jZS1vD8ayAMRSiJFLRxVdMmgk3P_O_7Cr8NILA6RMbPn2kZXRG0TvV4PWf2eWYbGrZLxftfjg7rs0OvYv7B_5UPNabBdVnEqLwiuuscidHFRP5pPmksAspJZQ6OGch12EewlUVKC1eCZAOb_yqtgtBQu6_k8i-TcTeC4m072Lrb4aNAGCsV2dcz4geUNAn6ezm_0DE6iz9VtWev6Oa2wNKTr5qpJEChEYCSK0DK1A7YZksLA7c4vP3BQbsuw5LHRv4EOxoQN_t4I0UDWjG0rgdbaNnDmSrXQcmtJ3VMFMNgO3OU7tpTiRbJZl22O5u8IA3_VXGtzwn5tVzI0RTxlzt65DqdCIX_H2Sy1NEmKYqDZCjOPgIV3udSE7uoAqw9fk-AVv0ABIw8KGxDzJIJoOOGcRagpECc-tJNB8uVPIAsoCcZvMLuMd2r7hf3-2H6Sla9JHKf7S7Z7atFVw1ql2hucrPelkoZXH4FlnBbqo1uS2OJicoH3DMxim3SbGb0eH2W_un9IlyeEe8o43f0dMCcIjvZQpXK89rRAv4f-VOqdKpJb2u7aAFZ3S9pM6ew78Bre-gFS-DaaS1TAKxcScnWi5rHcCgVfbO7OI8vZnD0mQ5yifCVwrsKUeXchp3g8zkNbl919nXaXUVD8ImVvCYalGsCA3lCwdNPDT4qFkdPwqjdbb3jSr166k-R-xuVmw8cFfDl2jtUFlDLlGJXY98IU9gYe3E--E-Ph1ZsWRDJk6e-5FYrBFM_1imXwFr8e7roYKTk4RnWB4OiRzFCYC4a12PL6W9foJOdTpKPu0vP1S7h9xfrf7RIInm-4wSbdKG73HzhefiujsarPjcHhrUtWXNIYOIJD1GsRbic1DoyovvUzpfnKZNrDIXO2gY8G02VmZxtod1gvgdRnvPxdEx7qyaw5S6lh0_xE1sgd6o-qvQF5SrDaVO-gn7x6tUlkbx8BbWGVB-usnHq6Z2i3o0m4KUVSEltvPrGpXrYvT47c-602D5gEWNnae-STa2ukJINxCjuduMBqA-FCYddPIbnc81IaSM2sJLnCTNFY-7fwGlsS8gdM8fx5_KKI03S13wkoTTnxjdltkGYlKb9ElC8P-tmq51jAo1-4cwUv8tTWAlqkocl-yLLzZbEQA0z5B6qTTH5kvxgj_F1AQuSfY3LqClkr5VYKLp74-h8t0LpwOvqcnfJ3iGf15KxnG0GmFQZ4Wax9g7caFcIrfgY2RCRr0_RqsvruOjCBvVUQd5s1PU5azc6OL4mdRmHFHGkHth4uk6l79RDS1npwX_3CNAnbm5MzcFPpk0MsscdRseKYrCMJWwsdaq7UdOVeEQhPjgjG0P2D2ABFnlgzsXghHp7AzXV43T_0kDmUuujwg4xE1oqu4ttYyyasfb16445Ys4yOpGasNEQj7x0rLq0r93suX_J6RrEDRHtYjL8QcnE0e68QlidHcnlLIKGOlvv3HEbC9frJNB87mQQLti0iPcY_qlGf9xs1yJ667QgI0eee_X0V3p4FklSAqhGQZcnU4ktzwf-miif2XEt-XupB5RA62NNIos29e5iO7jGWPchVo-pWhV7yb17HfKJUpyaCB1CVgXSD3aIv68ZSG8wQqNaxtDQBzHLMEM7OOXbs2oZjIOkzqMVGkfoHKYjF1sfooCaq8h4vt6rfhReu9dArMINVN_flfRk-o0wentH1n-dTL7Ld29Yziofe1AonPP7L2E1XCsHT8dCCjC5JRsDnLcTXna0B7Uj4e0anMORy2zH9dI16Tf_cd5pCDwDkhxr4DDPBDplIx2H18i8SQyuOisiBg0OOvzg9FduZpvDnXLY1_jTmgVeOMPWZPWf3TX3Ma4W_x77UIhBSHGMI0IJF7d-RU3Re7UE3hcj7waeDORCW61-lXCQd0ywNKczgEm-PwkMSAJvr6LChz6IgcNvAgoQSy013Mwco-pDas-ZvZ875vnv2TU8El4CA_IJTspm6bCsx_cDi-Ai9if_N9tnh6nK1h3ISB8xCttaPJJWdHa-LWJwJZ6LkeO4iVqsArl-9ALgGGSDTHEgkDzNrfzw_3W6JvjIm6zAxnRFYSeuojQ2OV4TU0TAwR9W5usdEH7r3EQIvPgfYH8fX5pDW4gOa2fkawhzA3WNy3LYfd0NNncG1qU9XRZkv15uStXfGu-SxK6-ppSgcNFaQkFsv6Cf7XCozsiceCWkoTYVTl1cLJe4bu3adLFcWywmZpHIPhHYQ-GsbLDu0FDVwwhN1tRBsmihJsKbn6PXYkYYh4V7_0s3e9BEKiGA-hjM0X_BrRsg_gtw1sFGzHK5d7fsCFPbnwgCD0ioPyirueJvKRjrfZy8B2AK8fYTsGK-gZIdxs0PnqeGfES5uRl6Ovp5n9Fs7Hts8IgwXE0XcBAb9Oa7qmnz0ljBcCQ-kkVfZ9nMMmrSNT1uGZinD8oI3143DI9ycvJSlwucPXVyEgdGCM5S2Sq3M0v6pCW7QrcMEtDtmzWS60mS15qiEfh48cwnthGio05OTWZko9cpS65z8bUUQUMJBJWWDjb32w7acfk73kv548uwlFs6SqIQ9oqHtvsjqbiPKX39ikL2MlN_NwnWqnNG55-obbUiuWl3JI_YTI7EwQRBDQA3kReoy-V2xgbbh5Wy4A7M1AHb5Ef7CvYTwpKK8PInVRRfupb3mBshXS8bz3XYQkQJqgiR1OHxpBNRenGwrtqxZidLARjNWlQW5P1NV6Z1RgasNgk1JoRnY8FlRX43k9wldm5a44EoIvyJZzZEnhLkTVZEdkvkBL4Cv9_j83nyqsITswhq4McrM_yfS__RJ_LxL_zaSKFseaRjAk44KnDqam64oRihCX41bXY487_GkZN_pyYaUBzCa7MfFl-BROa7rVgP4X0lxt8mxOR2jDPkkD88Y0WQW-ASN3pVgHZCImN-gLH8Ewr6rLQXno7wvtk6nEvnEm33HMptz_vc5Rm91_G0G6kEnJzjm9ECkY2znFWbKK4ztF5Cam6GPNY_CfWjnYk6Gj3nCHgskbCkvbIqHzsbPNJWrghwy2qO-ajZADOgY66D6NubqBLIsBbs3aEVIYygRiUwDE8sqkVzV0R31Swm_eyvd2cuhv2gnkeDxLSb4nX_NuSFo9ax7MQLfxW2fXfTIk0kmZrgzY2hlU_RFSY62dge89fVW1_eFe_sgZsdZoxqpxB1ffUPJcNPkUjKTaRbCfUzpts5MtTGE14LZbhfRotk-k_gp0vwq0113YmrwtDvSXUo5Ft3k4ZzT-LvdV4kTQ3Ihx7-rcpASTwEixDlA2OJk0R3pqyIGs2-L95dJXC1jZPyw8upFlnUYp6vNdOXw-ICD4DoMQguqTgFo65uIIwGcfd2JrumleDi5BiViFSeNMhXtqQZPP_1ddadPScATOMcG312dgZLLygEad9g_9jwXCAruo0Cub7dTbqRYKbM4lNv7NX_woMXeMdn6rF40lp-bpseeum3cKFOE-awfnPuVR5n7CsoSsS1XNEIQRHnRD_4fxjwD1MXUdrxFHfFJHTOsst1flpW0qogTxIlbw2wMVIlpuaGYC5o_-9ATC15skCE1hDC_fQlS3DO5BpO5SoamAye03f1G6SjPkJtCKMtLIIDEUxpXZ0v-LwDHvS-7e-9fMCLtG-7Qgq4BmPVgOv0VNcFxenSgGsDs7faLCJOS2k8Fqn6lhaMgUq_75BJekjI9Am25T1IIK9bDey5H5i_QQVxGJupyX2kMmUa10GP4zGzv3ijXVxxv7oudIn_wzvOjfgaE8LsY8_TdN7SHv18hD7PWSUPSuC9V3OWlfEugK8lXU-GI8FOpAk9-sBMto2J1bS83mghyt_FAkcPi8G-P_o2l3FRPnfD6vl519XXEebNlks3lY4Fyo-wMfr8sgEpP-p2M9ZHwsFC6LpJbYcSQWsPd-6SzaZOP2fQvQ4IDF93ZffigUQhk52_gbjqvPxKWjGX9HuhEP-XlbeXiG-_AOR-IjGt63CACjTlNm35rl-7M8c2454w--LgIjilJ10d_HBZcd2HmWMyP-zJkpUPU99WGAHdnqCmgoJLK-aFPVV2iGkhnbk8Vl3mXBCC4P72RLBJf4wR8q5-cJ9Ln5NBerghoe2bv0tPeAjHnJlVL8qabq3Sib3xUuuqcso7IbLZPWXscZLy82fmGIGs2EEJEEXUe0ORJGKmc2uhzGLxYvJGcjzpI0Ehg9w98McVyqM-wzBnh-5Z5sFmXJX50TF5hvisx7kkDmbThuNxa4MDzUPQ=="; // embedded encrypted payload (iv + ciphertext)
function b64UrlToUint8Array(s) {
  // base64 urlsafe -> normal base64
  s = s.replace(/-/g, '+').replace(/_/g, '/');
  // add padding
  while (s.length % 4) s += '=';
  const bin = atob(s);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
  return arr;
}

async function deriveKey(password) {
  // SHA-256(password) -> raw 32 bytes used as AES-GCM key
  const pwUtf8 = new TextEncoder().encode(password);
  const hash = await crypto.subtle.digest('SHA-256', pwUtf8);
  // import raw key for AES-GCM
  return crypto.subtle.importKey('raw', hash, {name:'AES-GCM'}, false, ['decrypt']);
}

async function attemptUnlock() {
  const pw = document.getElementById('pw').value || '';
  const status = document.getElementById('status');
  status.textContent = 'Trying...';
  try {
    const key = await deriveKey(pw);
    const token = b64UrlToUint8Array(tokenB64);
    const iv = token.slice(0, 12); // first 12 bytes
    const cipher = token.slice(12); // rest = ciphertext || tag
    const plainBuf = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv }, key, cipher
    );
    const decoded = new TextDecoder().decode(plainBuf);

    // Parse decrypted HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(decoded, 'text/html');

    // Optionally set a <base> so relative URLs in decrypted HTML resolve correctly.
    // By default we set it to the current page location (encrypted_page.html).
    // If your content.html and encrypted_page.html live in different directories,
    // set base.href accordingly (e.g. "data/").
    let baseEl = doc.querySelector('base');
    if (!baseEl) {
      baseEl = doc.createElement('base');
      // Set base to current page. Change this if your content assets are located elsewhere.
      baseEl.href = location.href;
      doc.head.insertBefore(baseEl, doc.head.firstChild);
    }

    // Inject CSS <link> tags from decrypted HTML into real document head
    const links = doc.querySelectorAll('link[rel="stylesheet"]');
    links.forEach(l => {
      try {
        const newLink = document.createElement('link');
        newLink.rel = 'stylesheet';
        // resolve href relative to base
        newLink.href = new URL(l.getAttribute('href'), baseEl.href).href;
        document.head.appendChild(newLink);
      } catch(e) { console.warn('CSS link error', e); }
    });

    // Insert the body content into our content container
    const contentEl = document.getElementById('content');
    // Clear previous content
    contentEl.innerHTML = '';
    // Move nodes from parsed doc.body into the content container
    Array.from(doc.body.childNodes).forEach(node => {
      // For scripts and links we'll handle them separately below, but append now so relative elements appear.
      contentEl.appendChild(document.importNode(node, true));
    });

    // Execute scripts: find <script> tags inside the inserted content and re-create them so they run.
    const insertedScripts = contentEl.querySelectorAll('script');
    for (const oldScript of insertedScripts) {
      const newScript = document.createElement('script');

      if (oldScript.src) {
        // Resolve src relative to base and add cache buster to avoid caching if needed
        const srcResolved = new URL(oldScript.getAttribute('src'), baseEl.href).href;
        newScript.src = srcResolved + '?v=' + Date.now();
        newScript.async = false; // preserve execution order
        // append to body so it loads and executes
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // wait for it to load before continuing to ensure order
        await new Promise((resolve, reject) => {
          newScript.onload = resolve;
          newScript.onerror = () => { console.warn('Script load failed', newScript.src); resolve(); };
        });
      } else {
        // Inline script: copy text and replace so it executes
        newScript.textContent = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // inline executes immediately on insertion
      }
    }

    // Now decrypted content inserted and scripts executed.
    contentEl.style.display = 'block';
    document.getElementById('pw')?.remove();
    document.getElementById('btn')?.remove();
    document.getElementById('status')?.remove();

  } catch (e) {
    console.error(e);
    status.textContent = 'Wrong password or decryption failed.';
  }
}
</script>
</body>
</html>
