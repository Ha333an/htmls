<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Encrypted page</title>
</head>
<body>
  <div>
    <input id="pw" type="password" placeholder="Enter password">
    <button id="btn" onclick="attemptUnlock()">Unlock</button>
  </div>
  <div id="status"></div>
  <div id="content" style="display:none"></div>

<script>
const tokenB64 = "P_IGJYPoK4fPXesgKGFQm6bRliwt-ca0R09PhWpfaLZIfswvbZf4nVq43Apy6S3E8wC5z-YyTeeV1yyK-kbulN6oF8vTbjWonLy3zbOWkwkMIslndbASEFshDbPgSvYNfkvaEvb38k650WIuYKKgeBwdPwGa7emPBBQ9BHD84k6CQjFP6Nurg41Hw5eIFcZpb9cOHhrtVQce9VxO3k-ahBVGBYIzDE73A3qJz7vEdm5h5l7qQQ3KvQRBDXotJUgKN_sDQq4f1vCyQhRfCCsLiXk0kKzPN9-d7JH7dm41L3UBjzPs0H_kyA5-esMJt_a2Whk9NQ4yYdRxTjgSEgcUXkw_jIudvCUtMz_TZnqLJapd0NvDhzZMVwBsI5AM9TxlCCPLTBr7_2e56er3gROtqaH0eluygXsojjAGngJFCQLGE8NVQVStPnEJRQpEUo9PX5HbWPZ0Rl60XqFgGXCEjeN9fIpQtTZyubxFFG-oMZYvj9z2e_Nkq8hOxkZtjX7QG92zfgeaJXJLjamg5auG6YbymrNfVF69lBxgTXwPObl4qpaSEb8vTNS4rJtD6LTuF4go33yWRDZLm_KRB96TXnuixRYaS1RvazJN69wcvoCpZ-40Ulrf8d-uEkkyJNJvTLp95ODi2N5zXdblaJUt1YT14pWz4c4c33W-rCVafNa-IBfQfPyYri77C8UKoyvaYGtPr_iz2azTOiQwqzJZBVWWjjM1KSrrK07g_B0QZOfA6gvietKXmiZjnGl7iXnKykbgfQ1VqzipLFHPBClA8BPEVAgEiq-MVZXyxm3kGVqZLyNIvpAnYX9LRMCs8vyryrfSgLLlsGPBa7ohdPjn_jWeQNjwkbQ7Mw6v16HPmJMQ79vOxYpcnOeT_zLw_HtrnUev2d9BVQ862nZaZCFqqrDr8aznZcaR4_sfG6tXjdZ5dJwF4DhX56nVtu0x5d1DNvAm106hRJsrWAwzdtN4Y2x1oNIponEKz0vgBejwoB5tbPGEF2HNyPS5RdXvTK8sn4uv9n9nHRmA7LaDkrVBDsu_15oGmuAjA0mdpvpZ8B6kD8CBI7BtuTYWtQDbdTUSZsZFFXyOtdVIHlp4og7I-m3Gl6VliQ-jjzdYY0TZ4hWAI1qHVnBYSql6TYNFb-y7cgqMX-Hnw_KvVzdvHwc1fYbDfvIhGPn1SY9vFVODlxCeuM_69AN2bxlyNaTI3GWpJHn3ObVTziaigG10vvZakGgrGluW8hk23ZD7VDHJaZDu9ERiBvGiZAHRU3gCVX1O9LAohP6O22JAGkGW0LqKOdUqcDvc1_h4UJA5cigfRhIlIyVLHN1EdBAUGFTwSzqEldQipabDVnTyGC8wD_-HDvuS1mBdwdkRIq9lH_o7-AavOI8uVlQWLSlSNPTi2Kjcm-v2WpUtyMLIS6fUOox02F5qpntNlgF5hn2rooFd8NC1zg_24ypbCAV0HM-9JXk2YARhv2qWu82RqXaZI5cSfqWXKq7LV9Qc5GXmERGlqxDGkNY6mPmyC-kCXkHXKPo2VAwV9sJv2OK4U4zEm79FkFMLljTXOABIqPZxFJCftIH0FgR7oalpAKF7vkcIhGzEHMk7na7lUgmHuiyZcBWQ0SBz6IapHvhYBgSUGqz_nrnVhlVqPnsR4mFDadarjCmIWwoPmJzvXSONL962McfY5RVH-E0VEHSK0_V5Ex6ZtJjdTEDRZ4N4RYcFDmM0kLJWvzzxW8Tc2dKB2ooNE6boTrThhZxBV8o-x3kIBPtOOLIQ1W2oMaHG9fnTBUrKiV4c4rgq3hiUJSyDk34RbGYd32-O8kKZrwfhcMWFmANfhZum7639knuFgYB9fobZ6WUS41etLTHdGdFK_wZVzlIhjlIDyDkBFRyHXdGzuXZnHBEKlQ1K4csyoSXHrzyTJd4e0OJKDPrVYW4ddiDgsuGsPsc10KTY2zkjj5EGBFG2URsGwDlMmwU-6o_DEl6o0Zk1OkyroUs4-tvak6VqH4atU8K5AEZBFK451_54mpsV2cChkRJ6A7MlW0nbPgHdNInpCpKJPqT6JpHXb1MS-Fl5gq6bPhoGL8dMX3hH-byij-ubVJap1ej2wmpGtxKLsaO7iOmnMZhiqDe8PioszbqUUATgZs3koI2q6ksIdZqUQEQRAgnqjKPQGL-zEJiEtqb5uGNwaZw21su1kwZqgxK30MA8gRE0hfSEALLCqIvd6Bp3G8lNjQrYX8cwKQxiQEStL77q4p021T9jptxlOnmkMAeh8Vtj45XNu3cZ7DAkAcrhyhBqsPQWdT8lYCvzv-72b21XNNbx1tIlUJmP_DhBXstbWo0KFOgLzx7vJ92djd5i1xbp3-_g2Jme1oACfLI0hwC3dzcZgdCoqkV-WIomQeHUZ882coH-NCKgUqUjYzHySXUEqCjsNztJ--Bc677W4kI2p-MYBf-ex6kg1LFuD9kMrkGMLSTAhH-ZfbHT3GH01NclMo8F-psArT9dqwnR270cINZIaa2dybzOK1zy_fbE0_GUXuvUhT6OuuPuUxzbRkf779V-PUcbLfs2rXRSYCsUuODzPK2ldhajFghq6bjvrWOF9UQZBLR1Od0U5PAElGskXEOLNjVv_m4xNDzl_D5I2ygEv_BtjPY7YlZYSmr0UWjJ0VPJw6pWuGoIvyBoQOROHYCDRdJPRJTgyDht1PcmpEILQC36Hu2-_nyqx6tTNKpGu_0lt9asvFzF7uAputj6AcZzaLhU_JBaKrNbV2s2ZN18ebGjTLhED4C3pLdKJJcmio7f3nq745MoCQ2xuam9tRGt-GV9v9VOVoIKWWTJo_gFs83nwUtQjOQi2xLJZxbjCIms54WwyBfmibVDnOBaO0RKodsU_18lrQ4k5iZTIQR5sJ8t5yEN8281sBR_-JJZVLCkI77LhVf6wxyvVsHW2SznbFE-AtbDQSz1oZ8U5V9uYuLF6SWHEVTfuT-Qb5HZNDP6EVloKlbZjHzqI2TY_DocSYAMfWbZRV8IyvOANZNmII4zAqZ_PHvHWysA5ZPJG0JeFQ-fBs_z0kZ-8OElL8AckHaQgSNiUa3IQwTcQoiOXFTUOjFlaLjCjOCJES-vJlEtfpqlquJkZMDo7cHoAMPFc46LUEAAZYogG8vax1PltT86_SfIOLdG2UwIAnU6jq3zf6JHlkole6sCFada_LCVGOZPfzN-Jvb4hP38uj82GBPfgPZVYAUwRjTL41BYCJtFW3OiLo_QmwAZ-2yRf85fB7TtY98MXAJEoqvVScss3x_xovAYhmaPg786flLfXnEKN8X7rE0jIKnv5duEhFmIyX7lGPXjNIxb3rSV9CuPtnRuQ4418t2wsoLq2VHzMNSt2dMeBOJV50JNc8UhfGgErwFU59MGcGo1MCUIquZjHlaWbrH_RFnbSeu7prqeNYfMvvQDxRCUPaNpS9o6XRiJAKFOpSjPPswFiobvmBvBf1L7Uv_-shj5dNZAeog53Va8Bt0_g6HN9HtdQ7ev17O1xcpA_D_dMaJLLpi-HnbK-jxh4-Gh7RD0nUSa2d5yVxQh0NJdMZVbTTqnbBoXCoDtA3jPS6uLEWIO0ZAUOUQsMMN48Bs2eZNEUVIunzCodNwfitWyGR4bORC0GBLP1OqjgPvDdh72uugyoIa9b9PNl3pMWCaObwTb1x0e3bVlsnTFiadA8jCl_Yw3dhpqAk4Rt5RSeUAm03W60cQ5EZSkwLr2k5aRCke8wGVSsUNEPEOaCCaVnRflR4UyjeoiWE896hftFuC0XZc5Wd-hKc3PgUWVaWnc1PoU159icvjN9Fu2PQMi-QGfgpv5Dlx5xNcGIXbqYbDAeBUbPM_qFKrbsTVPY1OQ4BnNjDmmkxQYiIGqJkHPJduoJaU2eiTkC1qjorcoSF_LA2hKVuSS8VgDu1Oq4b81puqlRUqmaeA8z59-N3il_T1Np-1oc_DPvn6gaOCQ0HfzWjXox-qbNT0V1_r9epybUYabfJyTpgCd2e-5ybXdCGkNCORU4RCXZI8V8nNTFQb3xitmXoSlAt07Bg29ycIs_iHGlEj9CpgJxxNkp-CiI7-NO1D0GEs_ZwAIE0jQh-H5d9y14_cI4z3xU-Cu5ZG_ymYwVcD-XExuOPX7gHYJpWB1_NsgygwQ2rMyun8pF_vyKDYWr0eWHhE7NUZ2BiVj6NaHEAKS1m96Nx-q2oZlVoh4SW9xGqPny6eJ0_YLCUWnB43wXCMWxjf0LSFXgbbdgAcJohRfEDrQPDg9cUNyib3Ysjzs20VKU02iyj7kfFJkpCG0VHpD0EybS_dfRf2n-6f2OU5F1II5fx8svOZa5L_XCuA68KQHoEbhcuWJoqmyiHHM9uDyLKfmrx2jJYfpIegpiWTyAb1W4_1_69eCLz7vjSRr__Ta_5PHHjaXa5l06Z2ww8Vad3h0xxbVA1nuhyLDdal4HSTr0tOOAyn8oOii5E4D6KWqb1KbU_081CFVU0DpgDfsGLmNvfhzC-5NUW_6MgFEAR1Gs0rYS9-9EtvB1jYp60xicuiQKYkv-1wcgbTgOpAdLydGDce_b18Bi3IRwkTZ4liaWk9r4GCi-wZmbxcGujPfBxOnwKGdAFIf6daU5URVHT-ZpPQYEcr8JxucFOGjUDZqXfFc5o_Azqt-b5CYxjuOL-_vrrI94FaaqsmfHeiFBoNHQITsS0apjSWOPRVasn30TUxHcesaRfdAFGhkcV_nodDvOLFyOpnWGFQyuI2VtEy5iSD21SaloQ7k_my-Z0n-zm9-ug0EVyve00q42R9Su5qFixsNDiiwUvm_rZMddCZnD3Z9kXrOrpoQzA9yYyGQXfR0i2ITBduazzpZHE1p7v3Fth7o6riA8liN3gvMxXFDeTxccQWvgY6wlj-hkE26Gfv_LmUCRIGpgfjsFopluoGrXHkE9LjZ_6RnszgUFW1LTmYtVU0U-Hm9WPlR7Li1t8rILJL5dp-GoOvsHmQ-V4I0wpFNtclu2nMg73MpaABBzfnL3E5KSOvwv8zEp2dh627Wm-Uw0VyEIPI7NDmZETAAZZ1Z4AvtgiZxQ0a1sYdFaddAbRjIMuRmyhmjZk96nuA44smGMLj0pQ-KWWZW0Lqhos-zvErIWrAzjtLz"; // embedded encrypted payload (iv + ciphertext)
function b64UrlToUint8Array(s) {
  // base64 urlsafe -> normal base64
  s = s.replace(/-/g, '+').replace(/_/g, '/');
  // add padding
  while (s.length % 4) s += '=';
  const bin = atob(s);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
  return arr;
}

async function deriveKey(password) {
  // SHA-256(password) -> raw 32 bytes used as AES-GCM key
  const pwUtf8 = new TextEncoder().encode(password);
  const hash = await crypto.subtle.digest('SHA-256', pwUtf8);
  // import raw key for AES-GCM
  return crypto.subtle.importKey('raw', hash, {name:'AES-GCM'}, false, ['decrypt']);
}

async function attemptUnlock() {
  const pw = document.getElementById('pw').value || '';
  const status = document.getElementById('status');
  status.textContent = 'Trying...';
  try {
    const key = await deriveKey(pw);
    const token = b64UrlToUint8Array(tokenB64);
    const iv = token.slice(0, 12); // first 12 bytes
    const cipher = token.slice(12); // rest = ciphertext || tag
    const plainBuf = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv }, key, cipher
    );
    const decoded = new TextDecoder().decode(plainBuf);

    // Parse decrypted HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(decoded, 'text/html');

    // Optionally set a <base> so relative URLs in decrypted HTML resolve correctly.
    // By default we set it to the current page location (encrypted_page.html).
    // If your content.html and encrypted_page.html live in different directories,
    // set base.href accordingly (e.g. "data/").
    let baseEl = doc.querySelector('base');
    if (!baseEl) {
      baseEl = doc.createElement('base');
      // Set base to current page. Change this if your content assets are located elsewhere.
      baseEl.href = location.href;
      doc.head.insertBefore(baseEl, doc.head.firstChild);
    }

    // Inject CSS <link> tags from decrypted HTML into real document head
    const links = doc.querySelectorAll('link[rel="stylesheet"]');
    links.forEach(l => {
      try {
        const newLink = document.createElement('link');
        newLink.rel = 'stylesheet';
        // resolve href relative to base
        newLink.href = new URL(l.getAttribute('href'), baseEl.href).href;
        document.head.appendChild(newLink);
      } catch(e) { console.warn('CSS link error', e); }
    });

    // Insert the body content into our content container
    const contentEl = document.getElementById('content');
    // Clear previous content
    contentEl.innerHTML = '';
    // Move nodes from parsed doc.body into the content container
    Array.from(doc.body.childNodes).forEach(node => {
      // For scripts and links we'll handle them separately below, but append now so relative elements appear.
      contentEl.appendChild(document.importNode(node, true));
    });

    // Execute scripts: find <script> tags inside the inserted content and re-create them so they run.
    const insertedScripts = contentEl.querySelectorAll('script');
    for (const oldScript of insertedScripts) {
      const newScript = document.createElement('script');

      if (oldScript.src) {
        // Resolve src relative to base and add cache buster to avoid caching if needed
        const srcResolved = new URL(oldScript.getAttribute('src'), baseEl.href).href;
        newScript.src = srcResolved + '?v=' + Date.now();
        newScript.async = false; // preserve execution order
        // append to body so it loads and executes
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // wait for it to load before continuing to ensure order
        await new Promise((resolve, reject) => {
          newScript.onload = resolve;
          newScript.onerror = () => { console.warn('Script load failed', newScript.src); resolve(); };
        });
      } else {
        // Inline script: copy text and replace so it executes
        newScript.textContent = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // inline executes immediately on insertion
      }
    }

    // Now decrypted content inserted and scripts executed.
    contentEl.style.display = 'block';
    document.getElementById('pw')?.remove();
    document.getElementById('btn')?.remove();
    document.getElementById('status')?.remove();

  } catch (e) {
    console.error(e);
    status.textContent = 'Wrong password or decryption failed.';
  }
}
</script>
</body>
</html>
