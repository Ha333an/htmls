<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Encrypted page</title>
</head>
<body>
  <div>
    <input id="pw" type="password" placeholder="Enter password">
    <button id="btn" onclick="attemptUnlock()">Unlock</button>
  </div>
  <div id="status"></div>
  <div id="content" style="display:none"></div>

<script>
const tokenB64 = "U_S5KEK0apyZtgvBrdDxBF0fCWdp80N6L7dn8a7ooRjMN8dfcdSHs_h7TJ_WjxWq2CxzJ-UhKShRuaqSRuKqNeTLtittfosTWtpUKoE44Fs29E0ub4W8halMuqNwwOATgfkJegKPiRRLz5SRfv4FVTPALu1tfVgSRdXN9XNo77D1ojManzf2BTXW7-vaK6WYXljkhnNxcXsuW5xyt6yjs9-2zpCEA-h1IU-GXg-G-gDljY2c_FMj5rTL6Gg2jDul2rtPjP95qgNygbJ8jAK24ZxVIQdk6ifKAO6JVfVOdymhZKhTiArkk3wuOgeOa8BgBclekglVPuD-nlRT0EB-o7emFS40zqBvLq3AHcwTw1ZHSaobI9IcgHXxtTIBedVsNk05rDD1KYHqAYUN53ePx8Xa3KGpktr6bwzjD1neEUf-KRD_LiC83DxPgp8QibbulyQZRkJFamuWXpXX7gvl9jdTU2wUCLtNtNs9JelgoYq4pHhEHapvpiaka9on40aWHziw7nmsAdbUzHAu0KrQMB1GfWaJVcs6lA19gO2MRysGV63_VbAjLYX0ifzDmPDb-NzEmqWMoYv3M7SW1yA51_lEE6yz9gd_XRMONqX9ZMRYSKGasCrjy_KuzM8WtlnKzls4xuN5aD5bpgvQuf2x6xdj8Pen7LLJBJ2yoO7gLoFSk6DM64IacCArfKdaVhFAOaVL9g7Ms0MjuvDCtjX3jx7P7adCW8m70BcD5V6MS6tdy1Mxak9N82k7UnWA3TmzX1itGmvXZhqsv3P4ztf-Sw8y-8ucBVniQg7xogRhd3L9SK5TC9g5T5Z13bXv9QBKEiXTrwhYffC52ip8dtuCSc4UVT_X3BtWb42-1_iySXoeupLv4vJH_CwTBC2lvVJB6C3cHGZXSysfVFJjk7v5mJm5kMvQP4_UGeksF7w0ndc6OQYwmKm8LuszoW1n39H86tqIyNTqkUf568IvrIUh-uVIxi_yb5EYR0PewPhsnVpE-oqaOBSYz8D5HohE_pNRgaIPLkim_OaiY61qc4-xfCYWKYCj7zGfNDGmKh0v_A3BOcm3qvnQK8CRMHHmQEt4iXn794fcPPpsIrMs1iLW_DBvXJk-DrXxd_CUDySnAVoeobRVOoFgQFDkjBqTrYArd3cYRige-R6qSt4noymGJ9NBGm5RFI3sS9D5T2L4Yp8KwUpBcrbs9kHvhyAO68B0JNgh3wYVPXoT8Tkc6jx-7XyNklb0nW8DQ-DpDjb8dlTYszd6-Lb99X_V6LAGeyvoVei0dkcf4A3LxuudedDr7aLKcYmT6dhyiYYi3dErty56MlTD5PxB2RcFUI_waVh_DshiytMp2UZ0ZCDyfRRnOk6AZ5XrvTI2HzrUIeHPhOUXWck-pxYNdkW4Br7YKuSVMIUUMsXKhzgPuikZmQxlSIdWajV9C9-C18fJm6MyE2PTwCThVgD_hD4_7z9oATMm5_gvsAfOu7ssfMdKI66TwGo-tfGV2UTm_r2lv2nkvclX8Q0jq13GRkak8LgPWCvvtUzB1V5d7GGfwOwqDMYWXKr-IS7j2F7F3ICQG-LeJYOqRVy9B0HXstTvB5MilzxvUtTCYWXtcBrITu5ZyF1efe9koTpOGCem1R_BTOcXBXPtRyrynSi1i5yGrrUYDU4lRm9CG2C--MvPcbIJrRSdXCWwIER2ppqGj4NtqSIbL8axoFOT7ptoP3vHe5HnGFspScd3nRpasECoOiXfqGM8V1op9gY6eOdROem0iAcbq_Kc9QChPWTPxK6PNF-jEO42eGm9yk94o9GEvCN4OfaS6f0iA3GW9DbNLx1UqX4GfULICvHTa4G1T2HcZDO4bZwP-w4lbvSOIeIJs3DUwDUluvm_HpDBlbNlpLSVYmGV2CUVRBPQeUTIIMZSE36RluOF7ZpsUYJ5dOPDmCKRFdo00T0ewkgivWAd5ka8Z8sSMPxabN3gpjeqSqVRgQEJLaESWF5rlkUfjeQkq0C51Lw2nC7LF7zCSEgQOxc1AgmXTejACBZ22BTCJOyTg05ykFDmy11ZMzotR4ojwfuIz79Fa9BlPnUXyn4RyX4qd0Qrn3bLecPTV5NkrkcbssswaPyCLBWpNueZbGUt56SI8T6XgPd49L_UKFXysFGcn2uIXGsBMV53LJb5opoVwX2E9LVNsFMsq_2_pcNAB3V_v9AwS4g7sFFrLQt9LPBf7zd6nJj6D-JeWFmiLT-tUvSBQhwOjThaC8IaeE7iBeeCYMom1CmN7jmIt3DU4OF7FHPPCzI3Q4nUTRBAdjb-BDp3sPd1t4rizsIz7wetd9R6D3upM_ZkPtuZKm7IHewU_PPwHfJjNVE3pYppo1pCosjBaEHBYP74rjsw_RNxXBg239KY5P5p5xKTpu3bZVITk8nsFlp-AZmXa6YYTAa6AdeoOOuDlGTaGmH00fWlGnspev09FEMLgzqyR7dH_KlyGWYUKfjfUDeMK8cdCRWxVy5i65-crVsNr1M-xunyJYJR7HVB6kUox1wggpH6hXbj6lLuaxrKtRPp_yXMGA9UKpDZIek0y1I9Q5nyNcAhLy1WOco898M8q-JTlDz82fMZfHPAtIEuVAKI-ajqrgOSZmww8TzcWwuhUm1SSsD5LA5zEp3jPVN7HX13rtJ7R-FvoG2DOvOjYb4rzgMj94_EuE-mxrzgyHxDcT6p1_o_wExmX2i33JjG4yB0XpzU0KcuPbiqSG1Ng7Q_Pp-1VEuVFdtkg4DHNW1iwZ-EjQYnr1TGiGaZObztiWLkFJS8zrQT9swgA42O77f5PmybZMa1I5toL_ZqiKxSpFxnEfozBKLq5-zps8VEeR9XENhjk5gp5_1QUm4OLpIPxuXYpaxgCA_SXLvGERCh1a9hTCHXHu_2xclMPITZC3WrxDWVICJZtqn030RETk4iQTrLPSm00iU2Bq6nMIAzWcIbocW_V10RKoDrhoOv-asvRdSWwRniy6keDOWOTIWP4GTRGhHlSIL-1iOmpp80d5rle5Ask9wi3mMYn9WMfvRq3dAbibXYsn4N6Pde6WxbIfTQlKJxDb9EiS4TYTo8vv-7uot_GMkg8gLt7ZRS3543E30s8qcBIcW89-hybC9KW6MQkwTfgnpB1PC9z85CFLnhs_tBywi41RsZ19rAJ5qkBmH05izGRsU8WPCpIzeE-uQiUaNbqh1uR257iROiZeb6ZKAq8yiuuAUwjZqP6ToWN7767Evdc4CoO36rE_EHrbWzROdtr202iyrdntpk8wrAxbApR1Voi4TXYvaHyQhi3jWYBGZpukrM6MHdwPV1II0Xa52t3HQkRAApevHENCOtwJbjcURe_1gN08EoUWLocDcehRRn9hn2w2GC_rn-rGC0GnPLjUKT_Lz5GlhtfQMZAB_lpG2RyGehP5MXoTIHTibUdRPLCusXfYFxsGQe1pm51edgpTgmnX9M-j_gkNSw1iKlGIv0QfY07RH-VWRiqUdYvwy6HHcrThzzGgx82Entc4w6eahpm7i0YS50DHuzmVmkdE3rhc539NlNYNymjxowWd071nVZAL6wO-guNvgDtkl4dBNG1yivOouuAJbRrI9DUrtK0gr6Zk0YI7_9lh0hxUBrDjbfiD700FFNzGxza5oJ_xg3DRYCS_15hl3nq_i2Uc-wUPY2PIMsjllaYSbamEf3CzXh3AwOQ3TFZ-AzL_WdFCOT3kZijuFzZmOAm4rYaMq8kp1EqwYwkWODiFwtO_VNC41Xk10HodoV8hPeoed3EnfHAohOi6p5rVmfBthzRas53mBvKCupb1GBFeX_aKoNhCn0rjFFhPmWH-3Lvx6lc_Vw4bFxBywsfRSBWo5xw7L4VsQZ4bVoM-plQjgblWWCW-NEdJokpUak1TGNKOPqBW5ZtqWcL6_va2NhR6KlNhUK8eu3EnhHf6-HrQzcA3P5Ve61bGOQHOIi0hTAxBtUQXNgdt3mifO6gIb2Cxes2knpgzJE3Uba3lorW5LPOs2FCpZ1XIOLhp8Po1ooTTpqtAiXu54zbZRuKw8a0Zs4qnyZEYwMmZF-CcYSB-E6-u_nNM99UMi61cdUj_DuI0A2jpb3ozKQC80sAl0-0AXO67ZCcWnJjJgLE9TN3Px7oCDjSFyPmrOh5xr8fYJOGAaz_yn2HnVJV5PCqLRxOUkb4X5341nW78Jxvf_I1Hn_ibxk4_g-vDXHShmfrrhMA845SAi2seUke783J4uJumDCB05woy-NU2DmrT6OikE-TTLap-RnmMfWoboCy7E4v0wyizzBDyByhX8xz8LKWDsa85y8PjafLnWQiR-HkwaDyY1PyiB6C34gtKoP7-kor1wF6Nr7VpKQwtkFig8ifNHFPzKI5deMirQGq8PXdpAb_w7_kwmlTADONK7Vi2TnEXBl18mvXa_Ak3omrNEaw5_dDzPH6SRbKphK0xt9fReBtvvNPc5kk4P0EIvA0rxhedqjs9k9ierznCkb8icEAXJ4JV2hXdwhv3y0RlGJg630WY4ED8gsjQIzfHQ4uJQZG2gK30AmzFVq3fScz-urBSxcVc7KqlBJzswTcWoDQ0su4SEjch_vEm98yAkBpuV9iD-auzx6siLSk-AsJV4DjL1yKu2rg-XzZ1KFPFoBM52N16jD5_LexDvt_NAKLBey3Fv1EfSnUMn78ZdSEZ9VdCL0T1IEV632zqVg5QUutE7A9LbJlh-qZfyTYg5FJl3JcSoViCWHuvQiEUmJ0GTnTQ8-R8yv8pfa76RSHIm8LRi1tSI0Pg6dB__OY_BtrWY_IlfvS1P5cJGnxgMjSgjhsrjgeRNxgS8qMIbWTx9pwDvPHp3FBO9iXj-e5dBw7yulbN0VH1oSDfyvjeK03Ua6K05RytwCi3nxswqqE66wnCJ2hqPflpo8RDg9vDS2WTG1Wr4Sj_Fpxu6-vrAQiRF7s_LDOuhP-Cpx5mCuABozJu2g-JATvkBRMxJwLXWSW9I27pEQ-tS7hBsIyFjHVL1XrkP0CWlPsniUPZdKUmtTG6T2VIGq9Cqw31zpmE4mbt2Fc5IYgKjZSaWlIG5TBigJRc09uqeemheybt796DXp9raDD3OQ8MmHIoRISVlwwZQvndDfKKjeMMjfClfEoHVojz-PIfbUhMdf8TM9rRpnnp1K0UVWFSBrNxvTkJfRpw3z7j7IJoPRsckdp6Qzv7UAJeL-rruNkaFzw0NkgknOvnFC_2jVOxp3spJG-26hb66A6ZNR_ZjlAi3MfvPLL85kXjAR19-fPGoSskpZQpodXyUcj_86bjqB2tpiVbgRIXLYE6YdBFJqIniasqRJgDtpWXtAMt6res0M4Js-53-OxF-ppumfQUViAd08W42uqlprdtdxuja5QNkgVCCKz3iz0by1NiqU5Uz6EI0tU2O_7yR_3cynfqQEy_l7cNKoUacViZDMP02H0zdXuuv04W0e0L4JZyVoWlR70kmoQSOg5__1lb2eRO4rqktSWOpWZuQz2gKV3Y35AmxfYlqgHVVry3EsyzkDjyBbQpWMuSuidzERv4IaEPVl6QU1HvlSFi2B9h7SlGxN1kqo1a5LLsErNsfKakynRngDwKncE_kVeGmJc54MLjM1kQ0BHWWq"; // embedded encrypted payload (iv + ciphertext)
function b64UrlToUint8Array(s) {
  // base64 urlsafe -> normal base64
  s = s.replace(/-/g, '+').replace(/_/g, '/');
  // add padding
  while (s.length % 4) s += '=';
  const bin = atob(s);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
  return arr;
}

async function deriveKey(password) {
  // SHA-256(password) -> raw 32 bytes used as AES-GCM key
  const pwUtf8 = new TextEncoder().encode(password);
  const hash = await crypto.subtle.digest('SHA-256', pwUtf8);
  // import raw key for AES-GCM
  return crypto.subtle.importKey('raw', hash, {name:'AES-GCM'}, false, ['decrypt']);
}

async function attemptUnlock() {
  const pw = document.getElementById('pw').value || '';
  const status = document.getElementById('status');
  status.textContent = 'Trying...';
  try {
    const key = await deriveKey(pw);
    const token = b64UrlToUint8Array(tokenB64);
    const iv = token.slice(0, 12); // first 12 bytes
    const cipher = token.slice(12); // rest = ciphertext || tag
    const plainBuf = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv }, key, cipher
    );
    const decoded = new TextDecoder().decode(plainBuf);

    // Parse decrypted HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(decoded, 'text/html');

    // Optionally set a <base> so relative URLs in decrypted HTML resolve correctly.
    // By default we set it to the current page location (encrypted_page.html).
    // If your content.html and encrypted_page.html live in different directories,
    // set base.href accordingly (e.g. "data/").
    let baseEl = doc.querySelector('base');
    if (!baseEl) {
      baseEl = doc.createElement('base');
      // Set base to current page. Change this if your content assets are located elsewhere.
      baseEl.href = location.href;
      doc.head.insertBefore(baseEl, doc.head.firstChild);
    }

    // Inject CSS <link> tags from decrypted HTML into real document head
    const links = doc.querySelectorAll('link[rel="stylesheet"]');
    links.forEach(l => {
      try {
        const newLink = document.createElement('link');
        newLink.rel = 'stylesheet';
        // resolve href relative to base
        newLink.href = new URL(l.getAttribute('href'), baseEl.href).href;
        document.head.appendChild(newLink);
      } catch(e) { console.warn('CSS link error', e); }
    });

    // Insert the body content into our content container
    const contentEl = document.getElementById('content');
    // Clear previous content
    contentEl.innerHTML = '';
    // Move nodes from parsed doc.body into the content container
    Array.from(doc.body.childNodes).forEach(node => {
      // For scripts and links we'll handle them separately below, but append now so relative elements appear.
      contentEl.appendChild(document.importNode(node, true));
    });

    // Execute scripts: find <script> tags inside the inserted content and re-create them so they run.
    const insertedScripts = contentEl.querySelectorAll('script');
    for (const oldScript of insertedScripts) {
      const newScript = document.createElement('script');

      if (oldScript.src) {
        // Resolve src relative to base and add cache buster to avoid caching if needed
        const srcResolved = new URL(oldScript.getAttribute('src'), baseEl.href).href;
        newScript.src = srcResolved + '?v=' + Date.now();
        newScript.async = false; // preserve execution order
        // append to body so it loads and executes
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // wait for it to load before continuing to ensure order
        await new Promise((resolve, reject) => {
          newScript.onload = resolve;
          newScript.onerror = () => { console.warn('Script load failed', newScript.src); resolve(); };
        });
      } else {
        // Inline script: copy text and replace so it executes
        newScript.textContent = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // inline executes immediately on insertion
      }
    }

    // Now decrypted content inserted and scripts executed.
    contentEl.style.display = 'block';
    document.getElementById('pw')?.remove();
    document.getElementById('btn')?.remove();
    document.getElementById('status')?.remove();

  } catch (e) {
    console.error(e);
    status.textContent = 'Wrong password or decryption failed.';
  }
}
</script>
</body>
</html>
