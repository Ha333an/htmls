<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Encrypted page</title>
</head>
<body>
  <div>
    <input id="pw" type="password" placeholder="Enter password">
    <button id="btn" onclick="attemptUnlock()">Unlock</button>
  </div>
  <div id="status"></div>
  <div id="content" style="display:none"></div>

<script>
const tokenB64 = "MGQbWm7zagxuvLUcbyg4DsR6UusN6EhtPIU4O__-xOD4LszzHfFWn89lpAoCi3RAT8OXb69d1R-eMZrSy4tD0zVStzPaPnM6to9ysiLb8YoyaT6gnOHL2qK_jvj5qbmynMBjoELDH1fI8dbS6TAGdcX9RuonfebnvKAiFopGvfo7M1__hs9aAYj1F8DmwP9f5tNvH6UepdavixB-eopY_u-TQV_VsHty0nZw3SdUtsGKdZKYNgBPAfgzIDdChRmZuyh8e_LyKo68hBvrPLZopHoYY2DmuC-Yoy_ExfOSXELjRVGkj37cw0QEmGMjjfZka5zyiXYakNmSBwgJGhWQwx7htHR9qXVpjaKMgkJhZsUCQHgFsB-xzU0XvdmNfI6hQDPb5QoBxuPTZneIV8nPq0G19WibLNCMhfwhNeelw50nkcFmI3fnuEz8W2m_3bgEzDVAgxwwsjmNuCqf-NJRMs1iUB065UEbEz04NKxucsk4q39ilyCVEuRAXJk-p8iwVaJW0wunLMakKHl3dpyIKyNi5j5WQLo8IPwJXG1m2SuLfVphpwVIMBTUXKl8yyUgvUWfF8VQ9B5Wkxr1oQvC1BuZfdsunGLwEo5Bv7W_oo49bq7JcjZDx8vt1hdXMaBtq8BDUNM0mo57yDLhxoG32YVZJI22q_0TvbRLmu2BRx7IeYa7Nf9t9RCVGmt7xJhlL9AREDCbAA8Vy1epHb1cl2giD62_Bav_C-ptXP-56rj7M9R7xuFZNkvubJ5JpjPueiyyYj7wj-4VFvosfIDSOt6u0b0IqNtavfBlTXzI4SF3hA7lRG77XMdjCAZrG23NjCth-qruuKijxy5p-2XjM3_UEE0w998O5BkAnS0dYaiDwuOfURK1A-zILcSrqU1uiyS2UpFOMY0l2pb3uiRO4CaFCLaepNVOl0-KUuQhd2jkjVX8ptKKnnRDxNHNMG7rl53akpc6lT3KPDgp66lcQLGCNSUbXgG_GkBPgFY5VStkl03Pumxsx_PKJ4o-oC-xbS_UdfgkEhRImC-lIeYj1A9Vfrs_-reOVwOLh8Q_dlzMB0KgIP-avTbSagy-gNqv-XgRXdCUYkFg3rrWhB10N5nDHWZe5HGnuPig2LQVTWRRF13zbpGWBLDa86wJ7sxsPgeZhNyssxyMRzlJwkvE3X8rSYfT9OB3uBJaVXR9rDqp5EMk_VsVc4naGOqGuZ495Umt_QLWqotFq6YyykPUvdu7wkmWOGLFR1e_xbvBDc2_oAtdIq09Xyy2wRVbMH1sBzMJMz_au1n5eWMb9T_7Kdtk5hmwQ9Qw_v65_5lpHs7JPd07T-gHIqG-a1lamssxhtM_52kqE7xhTHN7FtEfGt8DEyf1cxF9pWxt7PvO0_qJ-oOy0mlpQFS3RVT-ldTwyKAOGRyK5fLlO7gDYSxkfpkBIjMWeskWc-UKDqQ1GlNKU8lC5oRKF41FOdvJ_zxpJh5suT0rHcUTQOkIeB0WaVaL7kQvrlSsLqIqDnDB2lFXRrjeAhigF5HloEIqY5IvMsHPKVh3D0OLy-uEdBq9KWx9ennNNPLMn5UZOPXHk2pjCGz52TJ_5uIHpNInYCXyodVkwGgj-PO3hRtqNoPMmUPsW6pIT2ZrZeaqZPpMuLUCsHwRN8jhjZxOW1H5h5snhsOFgxDyZCRS7rPbLb4H5POgvT0gbdq7PNSGymN3bld9FtQDt_eFly0JSU_kyIcS9cvVQEVICjA5UqAQ6ubyCQGSJ2umfRRT1fMLtDlpeLdLnqsUHF8Wa08IAqvOh1LQTxETJIxwe3-EnEt3LcUXYJIgP-SDXodgRXPbVorBEieKWdnJ89xkq2v3Yr6ndlewIVkSywEMrKFXE1vkoD01iJgkYs7VQ31wV46xmWVrCNqVJjqgrcMNc09D1JF_Zu-VV2fUeAOly5MK-Uz4ACAaN6MXLFuugwCrzSWcCkPp89gwUjeaYUxpFb14R868ekks2zPFKAcQj4vfgb3ZBm-2PpfpGtRtUq9I1lpj6UeA0UfqCns6CBmXi1AFZVp9yxTpQNXpvHUIdxs1afC9p__JIQaUixBUBR2BoanXCPZxyBjfHegTxMkmNROS5y4HNvKD3ChG749GqLN28uMJlSm9RSmKlyl8bGhw2TuJgedBLQqP0fLhnQ9x5jvnyQ9lly-uggjHmjclwQbVcSVP6sTGMaUuXVv7GZuSZy2QAD944pnfB0dF0EAXB0CPfjOXkme9Nf9somwKTlW-5h0b1qZ85GdYMENnyDum9Xqu_W2E6Z5PamPPw6XDoobhxLfJslQuYICw1VBKCxeczvXOQ5_Q7NuDj0XmA0DV4kFkDp3QkPEv2LNsok13vdWwZYXzleUUD9WxC_Dlbm4evzm3kRWpVW7SZ2R-tX3LpeXNOZExO6pubgsQ68g-xvhB-bFbRtFCG_MtFlfg5kFTb3qQqN3NJMG61MCB1HkT7XAKaW1SEDhD7diJXqqw7fdyA4Gml5EQyRkCGn9SGwAczibBBr2AFWsFj0oDeP-aEX8kVoWC60DV7THPpFIy0LTVjdddXtjj7nZQraFddBQ6wP_l3eDI5s4kPR2Cd7MODb4ekO2L2pG9vPwli0cHWcUKLnMJQfCEtCziph4zx_8FLe5rAWPSfShD_aMFBY-Td7PfxjCf48jnxewMO1mCuhlOwCEcS1glAENDwSJClcfY5XAYFW8o6J6PlZI4eyfvLMgxOi1W5FOtOnIc_blQ519mm9hMW97Iwr0DnZXc8pDbX4AjUufluWFWiwjfYie0iaLAnX6SkSLUGwhT3hK7ut5pnEs-MtEDU_d2HuuPV-0mNuA_rCIBSm1K610pSrk7dtb42EsIGmrGZ-dBslkMdzkhkToFlo-k0D2DRMsTZVgpsk2pG7SmhGyyRxOEgKgVEcOZRBu-raXQHIiQfENEySQpix-JEFMhoKoKvfgypHb5_yKhpyoLupKYzYLRAURoX6Lyjlng1qPv-2-ewnI_eIDnfD3UQKVkpe1e7oE36gQ_K2ZVjh0A8HdRhIKTVyRpPUEcGb_5z-Cosga6cBKEHNUC_Rb4sHv_d73JN3nBQ4IZyeCSsZVbJa7h2tp1JwYIJWYAz4DQQLBKfBywyk9YGPIfUOLuSyfm560-9vA5cbWPE3qX-5gCHTAQD4fPJScpbrRn_w5Hp-q1TqI-TIPuJn0mlVLLY6JSMFnBvlmriWirwnx8kGiEioXBnJd4O0lMdkZNNdilekJZtojkRucc-UM0VcKrza-2c-KYiaT96gincoySgBYFWsD7ZhbulHICKp1tkFoUbKXQH5AKQCoKF6HAv5uTFtPHpLZcDo0OEKy1f8_Z0zFneNgjtsqWZ7VgPn03bf_RGGqxhMcTvAS6N0inilYh3kaYtZ0TbfWpwGw8r2PGpRpC6HAPyApcqBl-RbZElmKlHFt-YcyNAszaXE1277DYRlYxzRNTRUBYovZgS8COu424TDAWqlrKKWRqtb__nx1R146A_mbVbOc1haHrL3V4_igh313U2rsQHgwaZi9qaBwUZX0u9vFK9wPoX9VZb0G8UARaQqDLqyKMUnCBvwqgf02tYl7KABZOIwFZGgDmTUIj5d59IBL4p6ZDvKrfOjNUoud1aoLs6pHHUJdKDO3_hMLB4Pzi6OWdN0-dfWLvoG1HM068V_K29ocY09byGjmF0Le25gWvwrlCQoKTMI9WzHQgIjsO5kmPwZU1GAvrPQwCzbLIrjeCxmLdkkyrQDNiQVS8zVpWu70F42Yswk9H2MwWT168AiqNjtUfVst9v8xsNhp-Vs9ldiEc8T2hQtRJj8nqrbsjOYlI-1WXi-0g4aeguPRV-2F8LmGEHH_RatL5zodpeX7x8MPFXqMVWTKJ-CTVNhGXN8R7gkjhgwltZ4qyqiatDsE6oCgfnmNk4-qtJ_px8Cc5Z86NFcznRpJ6H4_FPpPch5saezjbpeVKy1oJvXQ4e4t0Ch8YPBLq4ZO--I2Thy_XYK5Mfm2o5yF4k2kIY0DIc8Zmnc-qJMf3OsCQhZmJiflafu09RX331d95dLtVk4ZYJ0drhMu1RcBxS9zTP-SbwJPowoEigNfJKccg6QaFFHbDn540du19zuYxOkQmxgflQevqsu7QJdinH1Tgu3L1Nmr-iUjFzAdHgY6FAjyXL-6pgS2q5KZC6tHyBcuN6kjr6vQYdpNvawUhGfu9vf2wNyr8iqp9GWgngZNbwoBHfdlfAmC8ABnNfD4jbIXaGo7v4cViVrLejAOQ2rsuA_u9KGoIOYj70QAYb6ALm-0m60tIBvNQPiWil6jnyaaoouda10bTpdi7zZRlKfzljUsJtTtf3VYSsSnI2hdemhzIK5r9WXYyxgswkkobv70omSu5UikTVDOWcZjOb8ubptF-73P-3s2Y0cqft4P3Yne9bKUy4CSKq5HKadKX174_wtwReQEha7A-Fj80oQI62ntIQva5nPOUOEct3XJnidROizOPIRnWvdnwdz0nuaNnXzUw-DLW6whNHcJGjj3rfxlJzk6D_2ZSgaYBAzgnTi9o4GazpcaX0sB7NTlOC_zEbUxe_T2Iqn09wpjxQdrhX5nV74yWqInENptoWpUX5ExbSMXojY4Sd4N46UkrJktzYqoBs1vagmlm786B_rDdOv0_tEYkzIozwweDP33pc8zSlPWHW-FOLlRPbeyh77MlMd_rJ0YBVE5TXmOiyMFm8Um1QFEoDy5uSnNgkKfKu0uCpNj-MPLqh8Gj1BKejYAgqdNe5lDTcKTuLCVOotYK2q_lrqipWTYXrmwaMz0ZrQlfAVWjmhduyXHBPj0kgiP6dE5q9ctRk5V2y_r3K9toZt-bDO-RBgqX33YeWXLP4JfyqiZeyB9V8C4vaeyDiqbZkX9EqZPSXPJdQmIHac1qkx3YPoe1DxLyKiZgFK51-1olPY79rbIIaCjepkApzbp1mNntIGjOpCgFcJNN_FG6qeRyc6dX_yh5KTWeWmLsB9WvybASbXCSTXdWDUd9lJqUPVeiTll0YzIvwTy_b5UVpcgF1U9GfqNdoX8MYmZBn_NmSnzaQGC0LnSjwaNKLDJlAl1Ec-V7PUwDEVC1Yr7mWokhiNHFWOE8-5wXrVqPLDo9ruSTBuvM2xkoRkACn_38bQu3R9BfjvXgxS342-SjcCm4_l0dniyM3bQ9Rz-7r5KLTw=="; // embedded encrypted payload (iv + ciphertext)
function b64UrlToUint8Array(s) {
  // base64 urlsafe -> normal base64
  s = s.replace(/-/g, '+').replace(/_/g, '/');
  // add padding
  while (s.length % 4) s += '=';
  const bin = atob(s);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
  return arr;
}

async function deriveKey(password) {
  // SHA-256(password) -> raw 32 bytes used as AES-GCM key
  const pwUtf8 = new TextEncoder().encode(password);
  const hash = await crypto.subtle.digest('SHA-256', pwUtf8);
  // import raw key for AES-GCM
  return crypto.subtle.importKey('raw', hash, {name:'AES-GCM'}, false, ['decrypt']);
}

async function attemptUnlock() {
  const pw = document.getElementById('pw').value || '';
  const status = document.getElementById('status');
  status.textContent = 'Trying...';
  try {
    const key = await deriveKey(pw);
    const token = b64UrlToUint8Array(tokenB64);
    const iv = token.slice(0, 12); // first 12 bytes
    const cipher = token.slice(12); // rest = ciphertext || tag
    const plainBuf = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv }, key, cipher
    );
    const decoded = new TextDecoder().decode(plainBuf);

    // Parse decrypted HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(decoded, 'text/html');

    // Optionally set a <base> so relative URLs in decrypted HTML resolve correctly.
    // By default we set it to the current page location (encrypted_page.html).
    // If your content.html and encrypted_page.html live in different directories,
    // set base.href accordingly (e.g. "data/").
    let baseEl = doc.querySelector('base');
    if (!baseEl) {
      baseEl = doc.createElement('base');
      // Set base to current page. Change this if your content assets are located elsewhere.
      baseEl.href = location.href;
      doc.head.insertBefore(baseEl, doc.head.firstChild);
    }

    // Inject CSS <link> tags from decrypted HTML into real document head
    const links = doc.querySelectorAll('link[rel="stylesheet"]');
    links.forEach(l => {
      try {
        const newLink = document.createElement('link');
        newLink.rel = 'stylesheet';
        // resolve href relative to base
        newLink.href = new URL(l.getAttribute('href'), baseEl.href).href;
        document.head.appendChild(newLink);
      } catch(e) { console.warn('CSS link error', e); }
    });

    // Insert the body content into our content container
    const contentEl = document.getElementById('content');
    // Clear previous content
    contentEl.innerHTML = '';
    // Move nodes from parsed doc.body into the content container
    Array.from(doc.body.childNodes).forEach(node => {
      // For scripts and links we'll handle them separately below, but append now so relative elements appear.
      contentEl.appendChild(document.importNode(node, true));
    });

    // Execute scripts: find <script> tags inside the inserted content and re-create them so they run.
    const insertedScripts = contentEl.querySelectorAll('script');
    for (const oldScript of insertedScripts) {
      const newScript = document.createElement('script');

      if (oldScript.src) {
        // Resolve src relative to base and add cache buster to avoid caching if needed
        const srcResolved = new URL(oldScript.getAttribute('src'), baseEl.href).href;
        newScript.src = srcResolved + '?v=' + Date.now();
        newScript.async = false; // preserve execution order
        // append to body so it loads and executes
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // wait for it to load before continuing to ensure order
        await new Promise((resolve, reject) => {
          newScript.onload = resolve;
          newScript.onerror = () => { console.warn('Script load failed', newScript.src); resolve(); };
        });
      } else {
        // Inline script: copy text and replace so it executes
        newScript.textContent = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // inline executes immediately on insertion
      }
    }

    // Now decrypted content inserted and scripts executed.
    contentEl.style.display = 'block';
    document.getElementById('pw')?.remove();
    document.getElementById('btn')?.remove();
    document.getElementById('status')?.remove();

  } catch (e) {
    console.error(e);
    status.textContent = 'Wrong password or decryption failed.';
  }
}
</script>
</body>
</html>
