<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Encrypted page</title>
</head>
<body>
  <div>
    <input id="pw" type="password" placeholder="Enter password">
    <button id="btn" onclick="attemptUnlock()">Unlock</button>
  </div>
  <div id="status"></div>
  <div id="content" style="display:none"></div>

<script>
const tokenB64 = "ohFd4S0HP92WGe0v8nfiLMfqQt9WnZ8lZoyYhMFE8LSdJwuJPBASWuMijMVWolArCiZYM0c9GuSfs3_9at_C3KFvPhS0zJmEys7U7kfgklVl3ox6TDGeIbykdIrnc2Wf-sQevIKzM4yc8Ala5lbd6C3LK56EgULQjaAmQ7DFRXuoZ64tCnimCeeENfprnuA3Fnxx_MV8co3pnin_6lRu_XRL-Es0GClNLdkPREo80v71EygXfPxfMtT8kxiLQ_MXtEHSnXpjLXYcM_U-de4fd6XlHLzRw03ealdi947GcBjjl51mxCW3OH1V_WvYxlZeD_M-x8z-wZE_pifYPZjDQ0snXgs9aW3o8dflxNlER9bxBV_r6RBN1sB7l16dBeKNEl3tOBlTGIfSDWyvP-sq6KII7qG4NVkIr6C9e0bIO0-IIN8Gz4MEURu7I4E8fsyv42Two1zvwzboQqirIfoqa-W9Bh9iFDomptFKRKCF4vEYYkmBYvpvSSVGCmw2TYanq8owv9gKexlfv8eYl8I-2W-nmTCH5nUqopXiGkCc-sQZk7PLW-OUC6OfGaiOnR1OFCcczq1NWaiYU7oM6cDBmV522tMLxSbaeGqPAQjMrdLwEpOdlla-0oVH0Y2z06LkF7phZwr6oX1IyTXk1cZBY83XQSy8Hd6Ojlv_4MbED6sjIjBKaOD6d__uyJ37WEgXKAIuBvVxCji_TfFDIbzZKBT36zHgAp37qCKRze8wX0TUmBp7uImFXnUXBXLXHjhnPa6ctXcJA2s2sHrY99jJQg8tAfkLiyscv22h4RfbTUWWAt0516CXrSMeD5_uUEV4NhvOERFoaFgR8za5hfnzWYI7kq4d8Qy0hBqhrYvEWIo12V9G6h_6yNIfG7msyOLfOwB2PB5hJAJpSgwYJ_UBH3PcVeXfig4MPurLfj5LIDFBuZkGZWw8_99Co8YLHP6wWdOZO5OmIPwDMLSKvyRlzR7nLiQ7xgljNC-G0tfPZ08Iw2TIfXgDokhXfXVLudVxPkEQ_MKWzUiYozoF-h5alLRj-XYaznuxiHnvHUe1F9bIgu7kuCq0JWn0qDFt1Q7iwEkd_QMGkqu9tDsW4itfLisfVb0KyqqPhzlodZ5mISMHkKyV2X-Dx2m6TwcRZhff_4YTT3W9CIi8odE3jLKvUeA90E4TanGPUC0MI7xGsOs_YPKKU9V60UwavirTv3tKEpJ3xSzoTaFb2a716tstrYg911ubAosRpGM5ZMTsDCBlpBcWqIvshFI7aKiEbj_CiRobA0rSEbULMykeZD9q0zQc8y9bxEB-4hp7XnuhTDOEqXLR3Qb3mKJ8br5lLLdmJw2Qpabvy53DAgc_NLZfTuJZCb--c4ThyuBYVffX-ygKx_JhKY81AeQMufFAetiMvefc7_-JdQY71YA4p_bGVuy2vrW_6CcHTxzQOc_QTwEKnn1T_fXs16bxz08AiZpND7klR2EZqsCdYa33yGl5adW1NycmRz1JN7BPd6PvgklGkIboFG8w7euRobizZVRx-XBrIhez4nviu_u3hQEibArlRWCPu57nAYwX0Bzi80lxFO3_WnrMFn1TmFfVc35Lt_pftIMLlXzQFVQ9IrSwo7UmfsHDyydf87Ka9n1MEfmZdBaaQzkJJ0DpezvFSFov3-jcqX-NicGHwNyFmXe2hyNnqTPW6yctyILifU1DU6PdCzHg3icAvYvEvVckZ-wmxjv3yP-oFLIW0I_XYzdQ9nUwjduTHXxJp3W31Jx2ot21Hl_QXGIlWGnko28a4aLQMLsKMsySP5fWT5c3m0XHKMN_0JWrucOcKJlGhXxocLB51Hmx-ca7TSE-ah7-WJQehRZm4OoxCoz3qrC8y_atLAuRHQjLiJ7EU8A3mfvysQjzaS3QAe0tm5Zl6YAjJNUaf8cQm6yem4F-swKVjUjw8SC4sZR55exIoo2CbBW570uB7_pcgOGUeqlqpPTZJE3pSZRzd_rsdwowVStz4Nk9LCrvNAePsBqP_OYUjyVu2lY1PseEcXwLpktzodGseRYSX6Pp3hIXvWUF6j7BkGYAhlLbk_7KC9OO0MddG0yhWUaNEQ6jrwlyJ6u8Cg_B9eqOH_1ykOsKt_pDUCUjyCMN3JKu8sCUVRuvYx5-eRXkzLaVEp68xytTY2bCGLrwag1Pu651QJnz8M2KApFJYQYhpZRVfUrgNjRyACks5OJxV8fLxxyxR7iTg_PUph882roV26OI4AWGg0c7McDx-S3M7qgGDdLoFSYSPoamRIbX_8vRs9-qbRPTg_9ThGo37fJnBfe0oTxS07HM8bqtD171nkk3QxmM53NCgSi3XAFAw54vs0x4_nNqNMZsMuYy6z7MmLCH9dnB932QjcVSYGDtj7NToNf9-wkBb-eIo11Q-4ncsmhh85_kcySnhBAShL1Q_mKjsqRZRIT_zT9kppim5CBinPrltgGfCo1-hbU52cPF20wplV2JZFkT7gIc03WLfNsIN9UA94oYjqvnKIt2dsWcnfLt4QVXYvn8alOdcA_ZIr_H1VgLIwrqQr9FuuWkIOrco_t7rtO_bIUxH8JaBagIwf9wnhJSzZjF-0R7cQk7-UUPHhYm4QYPzzx4wxtfjYengVS-QXJeQVSz13el-QhdRNxiX7_vVn_BzzvaivdgLn9DRKuEeJwFbv-bQy2aqaxHzYBcmwqnasYowwCwS_ve-8_Cug7aFkElILvY-dOh9t_QKoTSOP4IbIZ30L7wIRPr56JAfuQu4cKRWEkUpOpGyXwSXK30pI7K-bcb-r3F4kxPkSSy_pqnJOpSfy9MRxCEpH8TrYFtucKT-vPBRwi0fP6jvN8-rok4fvyEH4dUNJy6EdLH76KqSgGsoUzXCTiubk9B2ww3L45d1wwD4svcs0NZ9GLLO6ewdHbLzIDQDMmCisxlqw3EmYAgOhYm5uTsMpOYf7JZnnIiaL_G2jYpXQYUrcaSRR1uT_taDrZNzJXvHWaZ9Vc_XMquQSzEpBS6g0xqQEMyGg9qeqMngLQdRewuhuI9yvewtiRxAs-tDs-E3iCfJ2kYVO-bPo6k5HOyKpTkw9CfO0ypaQL3M4M0Lfdnl8GUMLDf9lJPgMreDTwOagcDauXDeDcX1pmwfhYX7btkf58OuKkvoaTD-H536f8688-nGITJM4_qBXOZ_sQSr_Tq_H6xqtTRO0faPrvuPY1-riCiX6z-zpkqbhZwIftjTI6HIiCPL9U-YrVXXlS0RwfS0hP26gPjn-d0SurC5bu55H4lS-mJQIJb_OFhh2t9dkXUa_MwmLbRlhhkQ4YB_R1KAAP0OJHPr__AmsOjk--kTWUet-gTDT43et8RY3uwJPY50nj4fCU39wEeVWlanoLjuadC_Gy8fajsGYyQdPnKFfP4eqYGkr7i7EIiyBEp44QZKsuI1rda6ZxA3gRw9TnJ57XIJM_xqw3Bsc2CloZij0g1DGmj8mlTkoZCtQbCzIXbblf1UJ7G_i-VYXm2alSMssqjNFMmIDgFdhYJqsIW17JfD4XYZlgbwsDuFLDoQHnOU1ETvGG-HTbvaeIx6SzsR1tX5WULhfllrFVlz33pWT3vuGmGM16ipUj-7fp6_nmDNt4ZR3asooNT2W_o6Ym7OB94XT93O2STeeSS7dCDJTE-QhqmGrc6tt6DXZiXOuBl8upmtgcVltUesGK6VMaX9XDN3XrY84J8wX3PiOPYeCQBHdi2SHptjcJriS5_UqAMB40uTB8JBrFhtuYRGVd7mXCZ4ujgB5bcyrhcVKaJVsh51Hfblw1RFOilD2nT2aq2cILsrgwb9-lTCqwvgkK-kXvlQGCjyQQh-pwL6FCKFQgbT2OuVG88cGXGyZI2JFsiBtoleRdMuLO5zjerJDx0XxGov1dRoXiWb5s-P9Gv4fX6V3SnQj92jwLmiXVVKkzkqVq8HdbLgKGrItAof3u4I2dZcIqQZo19aW-2TOJO2jFAevDwp26hWKia00n95L7Tzz8B8t0nRKjMomx_qo9ETp_AEXyx6yWHKJM8rJs5g90LKqEEpkGMWHwGSkA6wQ_jH5juW3hbjNY6EvIgoBggk7MDbgPzcOSJ4wdXej0nziw7QtA5_E3XOFKtpHWPUkAL3BuJyU1ixMuam5F-Qjk0-ivqMgumXDHE7M7O-ySejewBy3ahCXvexxCdEjEGm2IwOIjNNBJ1Xwa0KNHvLQrFfJv2SEwlHC2T4d0dR1tkji7XalQjECrhE5KSKdp7qCFkBlUxl2wI7yFi2QvwfizUX8zj2mvTdpfQhCqrR4We4PIP90BV65G9D10ISKaHK3oE3yoiv4dWmAYuvg8fvtyjoiWUjXAl-mw2qGBJZ3Wtz1F2GWWueqlWAlug4Ri7mdZxCP7OB0PcqYLPWnMfy8Mzi1012qpAff6ZBk7XjEORMWOEgA9lNpRj3qjA2ly6V_3onVb8jAyr1HDA6TopoxhLadIjHC_swzut8zl3OiI-R2ipG4S5AbWFIoPc2H879dQNuZHlnp1Ed0fZ9ChdiHWDqpCHeIGwF9OL94ok1QrIrYWgWJBoVrNk_16T0OsxmYZnI_v0VrhgbOwj0bEWu33aVXvKNj3DzhtZmf4aE3oLmTN6o3mzk2Ndf4v-INhcUQH-MmLfdK2nJzSKsm3R7ukJQl7tr_d3i5W7P3c0pPNwnoRkyGMPeZIZ_30OSjFgY9-e3Yj3tfQPOp0JzktAdfZL5XGDPx6Z77qcP7_TcWgrfgwurF68-LoXjCODcirnKbQdKETQWwQwlNTG2jEsFxEwKMxMfonbR91mcvwKblL8bVIrwFr3LLk-gfD5RKTTrZbu_P0G0-FQlXpoTDbeAnfgNg1zuOjavbjtkyP0hMt3t8iC4hBlnryLL-zzJKRsO-9QhduWVqdL-g_BxA7jn4XCre6owUKuUGLgRpbXGDgofz6Sx62WdlyWWktTPLkzWboLRUPSl_GQzVuZMbbutNHoKjHDgkur8f7-HxccBTScu8g2mny4yilwdZCcoKw9c2I2a5REJvWpnZko4WVi94YZAdWnV6rFBfV3wlMl15dTLWsCEWJ5ZBqzur0353qNv4kn-x3RR0bKJygpmRIDE3wgLmjOqUhi49yiz727KuI6I_fYNH_Ly9j_2NiH6PyyqzIXhDio4CwgYKsBZzxL4ITRbQ8fir1fnX5ILIc3KCa7U2_mcZtCSl5_hlddRQJQQzNCIVRHArwSrGMJSSQAgNN7G4Z05u2G8VkTmnKH3mWyx3AwVOw0wTNBNbzYWp17kmfg1pDR4dxTejetENZOZjMNisK8uK92H4VraqHkcxksQLGVwPjzuWymvKuxHssT6iYu_I70GHP7d47e20qSBBrvGolpFiSnSS8loowqffkvo1Tovtf0yoOebqHZEZX5epOUZbfCW6Amn7-65bdfJp_KciQAQBtIgaE4IJlaxIlwoj07bio6aRiFKDcsaUe9fgIVAw7_Z_2YFKgVtyNq3G_1nOe_IOjDJON9sw3QYb9-2hYTWqCB38Hw4UtPSLh8Wf0k5GpO9XYsjhK-yai_wSvyG0fFzjmr_z5QC213IRCtgKwufw=="; // embedded encrypted payload (iv + ciphertext)
function b64UrlToUint8Array(s) {
  // base64 urlsafe -> normal base64
  s = s.replace(/-/g, '+').replace(/_/g, '/');
  // add padding
  while (s.length % 4) s += '=';
  const bin = atob(s);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
  return arr;
}

async function deriveKey(password) {
  // SHA-256(password) -> raw 32 bytes used as AES-GCM key
  const pwUtf8 = new TextEncoder().encode(password);
  const hash = await crypto.subtle.digest('SHA-256', pwUtf8);
  // import raw key for AES-GCM
  return crypto.subtle.importKey('raw', hash, {name:'AES-GCM'}, false, ['decrypt']);
}

async function attemptUnlock() {
  const pw = document.getElementById('pw').value || '';
  const status = document.getElementById('status');
  status.textContent = 'Trying...';
  try {
    const key = await deriveKey(pw);
    const token = b64UrlToUint8Array(tokenB64);
    const iv = token.slice(0, 12); // first 12 bytes
    const cipher = token.slice(12); // rest = ciphertext || tag
    const plainBuf = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv }, key, cipher
    );
    const decoded = new TextDecoder().decode(plainBuf);

    // Parse decrypted HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(decoded, 'text/html');

    // Optionally set a <base> so relative URLs in decrypted HTML resolve correctly.
    // By default we set it to the current page location (encrypted_page.html).
    // If your content.html and encrypted_page.html live in different directories,
    // set base.href accordingly (e.g. "data/").
    let baseEl = doc.querySelector('base');
    if (!baseEl) {
      baseEl = doc.createElement('base');
      // Set base to current page. Change this if your content assets are located elsewhere.
      baseEl.href = location.href;
      doc.head.insertBefore(baseEl, doc.head.firstChild);
    }

    // Inject CSS <link> tags from decrypted HTML into real document head
    const links = doc.querySelectorAll('link[rel="stylesheet"]');
    links.forEach(l => {
      try {
        const newLink = document.createElement('link');
        newLink.rel = 'stylesheet';
        // resolve href relative to base
        newLink.href = new URL(l.getAttribute('href'), baseEl.href).href;
        document.head.appendChild(newLink);
      } catch(e) { console.warn('CSS link error', e); }
    });

    // Insert the body content into our content container
    const contentEl = document.getElementById('content');
    // Clear previous content
    contentEl.innerHTML = '';
    // Move nodes from parsed doc.body into the content container
    Array.from(doc.body.childNodes).forEach(node => {
      // For scripts and links we'll handle them separately below, but append now so relative elements appear.
      contentEl.appendChild(document.importNode(node, true));
    });

    // Execute scripts: find <script> tags inside the inserted content and re-create them so they run.
    const insertedScripts = contentEl.querySelectorAll('script');
    for (const oldScript of insertedScripts) {
      const newScript = document.createElement('script');

      if (oldScript.src) {
        // Resolve src relative to base and add cache buster to avoid caching if needed
        const srcResolved = new URL(oldScript.getAttribute('src'), baseEl.href).href;
        newScript.src = srcResolved + '?v=' + Date.now();
        newScript.async = false; // preserve execution order
        // append to body so it loads and executes
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // wait for it to load before continuing to ensure order
        await new Promise((resolve, reject) => {
          newScript.onload = resolve;
          newScript.onerror = () => { console.warn('Script load failed', newScript.src); resolve(); };
        });
      } else {
        // Inline script: copy text and replace so it executes
        newScript.textContent = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // inline executes immediately on insertion
      }
    }

    // Now decrypted content inserted and scripts executed.
    contentEl.style.display = 'block';
    document.getElementById('pw')?.remove();
    document.getElementById('btn')?.remove();
    document.getElementById('status')?.remove();

  } catch (e) {
    console.error(e);
    status.textContent = 'Wrong password or decryption failed.';
  }
}
</script>
</body>
</html>
