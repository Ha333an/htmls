<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Encrypted page</title>
</head>
<body>
  <div>
    <input id="pw" type="password" placeholder="Enter password">
    <button id="btn" onclick="attemptUnlock()">Unlock</button>
  </div>
  <div id="status"></div>
  <div id="content" style="display:none"></div>

<script>
const tokenB64 = "RhJ41-th6b76ClWK3PhN1zlXvRVa8assUTrKaoW66GPX-k5TncWdNh6JrZectBiVIZ6KcUb1LAdsgVNsCA7w5mpHX6f3vgUNKfGBo_3AIlqoVC-WkvEQ9ZTfzphlMNdsvEpk6uEVkonaALmBepetw_CQK8-VurpLr-8kSd7XbJcwLI6OD4c-MkjVu2CjzMMDmucuoktuSQNg-84oJsFBRTyI3DaOWoNDeNtE_KyzvJr4VBYy6bHDL_lVCIW2MH_CYbifyvOqXpZ0VhMl_O0D5hCpQdue1_1x0qZCW-FvicyLN_yrisDRtjqEed1pggr4HQyL4am6PoQpyeKufCr2K93MsepPGAo-xD6aMcp-VJDJOe1lfFa_nxWHAuxVmaIsnwyU-yPN0Jgt1e4lyQaL0P5gc99wkTtLQ-U-ks-Aj4KigMWP_3moaQiHIbhJzdrjqg55UuUaVPkK5O4X1elY9ndUo7C7AmOnBhUAsVunmPMTDm4FH2Q3evieLWp_0oAV4_QDDVqc3lUkp8sNR50PL_Z9TuGAhm4zLzmp1I0Ubqwq6UcN4wyBph7WKuB-m5iSnfceRPuSFI876KYyFapkodnmZc917G1keRJCSYbRv2EDKwVwzSF9Mh_TQ6De5a20twp5HJ1nc0TZbOjYf7ftSwgfO6LLzpeAC_qe1yMosdwj4_5_KJgmc7H5t9BMfwpd3bmNhWQ0zjw6m_54zgHrLaq1hyMc1pyfUwnrLgAYKkjqH1MGIAu7E8W661cmZ_1yV-cJo3sLTfCn2--TIB7c1iJUgmYpHCxahh-la8R1iY0AsQawFpqXkvyFQ--YX_lNv9U4wDpCXrb8Z_FAZrqrxvQiTx5P0Vn2lpBOlq4zbNveGztKycO_uXNu5y0TtpceqTDHnwnqLYFELZctFjYk5vQqNC7xUkZtGUxQ8muTAb2aRFVB0StJA7zS8ohZ3XdqpUhhcV0hDQT30P_groFqVaHuTohrf42OAQX3f-sr6LncaFgRwL4SiskM5MNp_KqoMKLNH7unK7U31szOVTNNgAr4lHWmuyOCkFLC39sis06uffUQXg2WL5WVwxwl8_B5P30GWKyjgxYf_p2aZVrmFQXGighcjTRWe_9bO-Yx_U9Xa8g4--mzKlw88JxiB045CEfw2RjCFkPl9Zui9DCFESxLQebOFfby6BbJ3Sg_U2irdF3YoYC2fPVaY5KCDeLeSes364_kU5gLI5rSiDRz3GK-Smnpb3KaAQpFiX2qGtuZBpsoMCNpMD1_qPoXI6ruAvf3IHoQw1s5TT8iAzaqpj5txPCW_H-W6zrkDA_U5C_S4HHaeAstvZO1PFAstdnGOLURdRTdnAE52EscwjeQQUdtUAScBfZp10fQboeL-Yw24McPSC-K6V7etSRK9I8AEB0szOAKyBuLwFOZfiRtF_wPpsvcX0AsAwa6obNjvmDQBrGPqIE2caqUDjTlsnZ_I275InW-o8-z45xijWvObPafAtim-4DZkPJfz7UcRwoZAZVenwqLX2z7-3FmV9ELCcVrrZTkPw2Ru4R7ykabAEtQaQwVugd7ulRRAOB2KCM7HLwP3t3eOnyRALvV1gvYNsk3VSpXoDqKqULE2XSrCE45BRacR_FnpPK4ktTmuCzlKrzgvy5VMFqFOlqOzrgIEKcNcU5WcVe74xws1dkJaZwhBNOTQRLDo7BAQc19gkOlZZTMt3QOViyALdPbIx3SDP6vp53-BPrNuTeySysb7_ydwYFsau6v1us4BmwWZXCiZckc62MtW-G-gTe0uVOQOe00oiLoMmYnp5_L_8zz2RlSxoquk3OMVBQnShEcGbWt3b0FgG7v7FPgwuFH0ufYt8iNfLn75y7PGZt4mjFxKZLaBb7HJErzVT5Bim90XuSryYqSj-W7l995GdnzLSD6AhR0tm09C1cZ2_um8y-JXtjoyLyc1El83tT6PUqy1V8n0simduYDSJfQTPgjUhThlCcmOXJzsGo1KfiIwV8h9VkPSkCJvMaXMVKalrpV-udW7InlGb66IMQClWAk8n1HQ8kEd0kQEFQjNNZJOzyuprv_ks3ey_rBb5lwjiVc3m81mFvHLzaMSO0moc2rvwfNOhGEmDmmsMfyitQiMTArOw9O3L01Fjc7kdZqCi__Or_BuoVd_OOnzggu9YKwpSFPto3sNfZAGAYZUv14fZnknoorkLI4EbijJZ7oaLiXvmuDBC059KGLSRp-SIpqBx8HIduJAOg-YWIfqUQIVn9ksvGladzBHxbAME7Ms2Y-uVysbFjr7ci3_egpSnmybH_7V80b3VO4p4C5-y6yWgRA1YJS2dlNwgbbwKR8uT5A5GQNcn44ZHN-mgfmmxdxP0EPV5E94-5EMFoGG2afG9WbtluqVTPpt0Z17v_S_NyFvOIQOjx6k6vhMonTHoda225BoncugmSYVOLfw31WI-L9m4r6VT0532CsLkCho30iHpRyoL1dpn9EJ9wXkdM8vh3ZK7dfzIGPjs1PEL5hvPJdZmlZ6vmMMjhS9yq_ZO9-qgBBPEhDps_lC_1Bk7wPv8KrVd7iD4yQl6jshoFDZ8WnRDyhqkI-MZ-d2l_ho8xa4zWR1CsjG0WtVpH7aa2RpPuFFuB2HxSxngFj3LfZhUgmjIC06vziT3VGFy7AzIAFK9xo8cGvCSRbAPyGvcJJf1QQ0DcMzs8_ATx3z3mPp-mOTSawuDejiF_OvVOwN8Wzex9YrW3sxsC0Qbk6Ne-NWgHV8JcPQu3j8T90R9GnZ1k9VxAImR-uMI8GPwj_Qpl0fBLvDK3dIpMSzEBoerkgtC_tD-ZDROg9Dt7H0z5Mg6kApEQafCuDGzfrp44fu-ifnq1Kz5GnUFxfc-jzDbgg4qxsOXnLJu9izMwFxCkXgr7hvBTyFr7_-2PpwL76-pigVCsRvh4T1VFHUd94vYFMQRMiduouQbAaWXj_MEmH-x1ajZx5gmAfHcVRjQJSIyaym86jRQmsXRRATp_aBEuMyfLJoZXb0v7OdYfYAvo6vbc22lJ6FE81oc5kBKG8-ByTXTKl3DSroVxxbBMXhcQ6o6U3s4mjLhtxQgT5_HQDDcupCf7LGuvwPXEeSfkXaKUWSxFeJ3bXA_rbt9cgiLNYyfjzWYetOpItH4W_iqzmv5NW5Nm3lzm_04agwlUOo75eIj3ker0Xl54T6kOWDE4ev54sfzC9ZLcLatit5KZRlvY4fd2jgI_yKJT0PW1t3TBCNsl_Ycc_cNNzcY8X4-IDAkSChbQS9M4KZ8KdHbqhit9VShzZIgNQcsR8hUcGRm4BHrm_hPzfHLXYpndhsE9rDC8fdDtFKJVH9D3q16eYeLWFrrJuJq1ELd2wPvh9EE9RkSmZ1o_8XIHEJcu3OcBQUlqJiNeVhVG92NnEPP0WAEnvQmavJ7piqrop5aN2zgGpD2tfdbUcZTLFUPZtvqj0yYSxLzpSHpZvXD_fks2WZErUi8kR1FhiAzxz52j7vrp3Zo1EgCoTmdJ2tmMGrSeoo7xBpBpLruGJk-0CD8FM6ERR9HnmbIc124ttFO1pQoPDYr1Z35cWIBFgR0F1fT_Fxyg-U6q7CN4bHgQDgQX7Rr7H7cyuOpBzFptALZXvmDmZrmqWEzSGN8IH_-nsp13ygZarFjHEOualqJa0Fdn6ZihEytgiXmwQQDbkKDj2bMdHZC29ahXfXM2uT98ZK92nBrB1VkmesVUswQ-bLywZwGw8D1zmqUTnPcdKxCCli_IUy9dhNQThb0rykQ1nylRCPl2Q0Ob0tTZNA5MVNv4susHmZsWB8P08FSgMm0XJ08lWP0HDtiLlPJaK0nc_Fp2eeSPFjTMS8_dm1tPmseYoKr5WYjWzKe80-FgfoHhY2OLr607jljtpjIzM0e9lGyZGL-nqgfIzE9TRxwkVBPSUXB0RAyuRhX-gn0nQnWXBLPTVmWpOMkpll9prNckYZ2jbUuCMUKfPsm31Qnx-pYZUeb8x1UyGvfAc6Oq-2IQSK1UD7PNucS2V3kCxImh3lHiVpqUEW5CD_rbewx-YA9G_FSaRaGpzzEUtTCEoHqmIAVavLMHmEjNW2aSRZUfK6emH_Ar7MaBbXoGA27L4bCKIIoKfETZXuZaHGtXj9dAseDHYjyIZcgJ7a7KZfhFEMEgI2HZHGt3RNmu-ipa2QBJA5J97ZtIsgY6s3soFExn1KBYa5vy7gWWWbes5heaLnkeIt3BjPpc3gGy7RXGiXPWmJT1mzs5KIQWVRmp9dkmYu3M2pniNG3z7gAh6r2pFLSY9uUoWshU41DrlG6gpNQZ4919gG400ZHvz5elEjcwMpSKjMoeqii_1MrzZ9bS5aNQtd9bZvg3qz51O-d8h-d2i6tvj2khteO7IWdaegAvS9Q1QJbv6XCYNNLUo2K_52kL584xeLi-z03HPNxVgueHYS3ufbZBxeUYiZbpgRHhlLrklVbsPHoXk_HPEN6m713R9BjspNnE2UWazJfeEzet3ktpRNH8OkQ49O13zZRk-ixvD0hCq8wxu7AQ-2D-86PgFpTVNcCOD09KnjVZM_te0uIrhd3Rf_uziqzEU2pRwFrQG7ODRU6NkINH0DfL3C7v3424poZVlTdYaoSpRwO66fIStZa5ABCKRiQcdyxWwJH9HdVYd6xQZgLM-l0jUX7ynlHHd4Gaswm3gqQINZgxfGwLklocfR73u_iaIbOT7QJVjoR1nXivMxc_sMHzruhdqsXUTLUSYV_QUJH005kfcCsp52gVszz47wu0tt51z7e5-GKOxV_W4wfiXyugztYptcHIpnAcoFE7t1s1bQrvPt8NKF1Y1aTZ27fcKFoJqATRcwYnlJiCXhh5XbJT1zLWK5Nz_FhQel0WbllrhpAzUe_SnwvRJ2mVH-AQrYL6gV3pRMhECchqL3Qzfu3IrfHGB6uq_w6CN84OCMZ8gVQrqwy-HwapbYNQylOyHBcqwOjpVNBkntTXcFQ7KMh2Wl1fTW4Khx_JJJUElTKBue5oogHuK-d6GzpX1rgSBhDYs3JAycgAnC3ybAkoHIegf-CLBLvZuOWs7glTujpi6NfQW-OM8_vseDv6PQSjLpgUHlgWGOJrsbpRDPElIdGl6ZGSetXoMQeKJMmEZn6Qf7ZoAT-JWzmCQ3jaG70otQIgdVkHfow_w882cHytH9LpC9Dx3nTci2c7QiVtVU1tacNLVjiHLjlGDxlZb7tjkLkx5mLZi4dDmk4-7dCtOZWYoY4MUa5-M1ynSoju5uxUnQ-hbIN-rA1BQ0g-HdvX7iYKhhcV-KKM6roIjdP_E-z-L5kqD8jWv"; // embedded encrypted payload (iv + ciphertext)
function b64UrlToUint8Array(s) {
  // base64 urlsafe -> normal base64
  s = s.replace(/-/g, '+').replace(/_/g, '/');
  // add padding
  while (s.length % 4) s += '=';
  const bin = atob(s);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
  return arr;
}

async function deriveKey(password) {
  // SHA-256(password) -> raw 32 bytes used as AES-GCM key
  const pwUtf8 = new TextEncoder().encode(password);
  const hash = await crypto.subtle.digest('SHA-256', pwUtf8);
  // import raw key for AES-GCM
  return crypto.subtle.importKey('raw', hash, {name:'AES-GCM'}, false, ['decrypt']);
}

async function attemptUnlock() {
  const pw = document.getElementById('pw').value || '';
  const status = document.getElementById('status');
  status.textContent = 'Trying...';
  try {
    const key = await deriveKey(pw);
    const token = b64UrlToUint8Array(tokenB64);
    const iv = token.slice(0, 12); // first 12 bytes
    const cipher = token.slice(12); // rest = ciphertext || tag
    const plainBuf = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv }, key, cipher
    );
    const decoded = new TextDecoder().decode(plainBuf);

    // Parse decrypted HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(decoded, 'text/html');

    // Optionally set a <base> so relative URLs in decrypted HTML resolve correctly.
    // By default we set it to the current page location (encrypted_page.html).
    // If your content.html and encrypted_page.html live in different directories,
    // set base.href accordingly (e.g. "data/").
    let baseEl = doc.querySelector('base');
    if (!baseEl) {
      baseEl = doc.createElement('base');
      // Set base to current page. Change this if your content assets are located elsewhere.
      baseEl.href = location.href;
      doc.head.insertBefore(baseEl, doc.head.firstChild);
    }

    // Inject CSS <link> tags from decrypted HTML into real document head
    const links = doc.querySelectorAll('link[rel="stylesheet"]');
    links.forEach(l => {
      try {
        const newLink = document.createElement('link');
        newLink.rel = 'stylesheet';
        // resolve href relative to base
        newLink.href = new URL(l.getAttribute('href'), baseEl.href).href;
        document.head.appendChild(newLink);
      } catch(e) { console.warn('CSS link error', e); }
    });

    // Insert the body content into our content container
    const contentEl = document.getElementById('content');
    // Clear previous content
    contentEl.innerHTML = '';
    // Move nodes from parsed doc.body into the content container
    Array.from(doc.body.childNodes).forEach(node => {
      // For scripts and links we'll handle them separately below, but append now so relative elements appear.
      contentEl.appendChild(document.importNode(node, true));
    });

    // Execute scripts: find <script> tags inside the inserted content and re-create them so they run.
    const insertedScripts = contentEl.querySelectorAll('script');
    for (const oldScript of insertedScripts) {
      const newScript = document.createElement('script');

      if (oldScript.src) {
        // Resolve src relative to base and add cache buster to avoid caching if needed
        const srcResolved = new URL(oldScript.getAttribute('src'), baseEl.href).href;
        newScript.src = srcResolved + '?v=' + Date.now();
        newScript.async = false; // preserve execution order
        // append to body so it loads and executes
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // wait for it to load before continuing to ensure order
        await new Promise((resolve, reject) => {
          newScript.onload = resolve;
          newScript.onerror = () => { console.warn('Script load failed', newScript.src); resolve(); };
        });
      } else {
        // Inline script: copy text and replace so it executes
        newScript.textContent = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // inline executes immediately on insertion
      }
    }

    // Now decrypted content inserted and scripts executed.
    contentEl.style.display = 'block';
    document.getElementById('pw')?.remove();
    document.getElementById('btn')?.remove();
    document.getElementById('status')?.remove();

  } catch (e) {
    console.error(e);
    status.textContent = 'Wrong password or decryption failed.';
  }
}
</script>
</body>
</html>
