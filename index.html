<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Encrypted page</title>
</head>
<body>
  <div>
    <input id="pw" type="password" placeholder="Enter password">
    <button id="btn" onclick="attemptUnlock()">Unlock</button>
  </div>
  <div id="status"></div>
  <div id="content" style="display:none"></div>

<script>
const tokenB64 = "ziP0p3UyMU6QAvWTjyzCEgSgQvMtRFI_JtCTQQvADaNXKb27Idh7kIDPR41cwEQ4CrxHB6Z2M_pxO_uv-sgcVMOgdy1IWY6SXvTehDLvlrkrzsXaQLFd8_FyYUNLhwAuqpM6_KotL5HGwCrbQF-NT1UCiT5pKI8wyhBO65Kaa114zAcnEvOSTVUozm8pO5cLma53g0B5BUUD8bfbxzE8z7AHsJBCzQNXXwmr-9449OVoZ8L9VFewzOJfkbFHGswgJeeXxe3m9uRuc4OXHgcwtWujec71D-TkUaUQcjsMbP3E5cxgStOtPFej1cStACQihN_xWBLEuE8GTeS6-nafMRGMUu0P8Gz5uFiRoX3ZTursSqxsjxIud0jqR8sLE-8AGYMZUPGIqlPxMd6Dua4HgBWNh89lhVBi6EzFBcCjBkhGRMMPTm7UE86cZIDOADsOzdFwij_2Li7_W2uJHhbrRMc_N6wvv0mW7Q75aH6hv4RDTCEj_CXVZXwzeKfI1MiErpVWBOtR3oVGMAKs6JHBEZ-YQhgXL3AvXqVV_8_13kxVgw3kgxvCzeR0rhS50YkU6wanxNJfwuA6fRZuIo6SOF2M1YNg9FCiyLhXJCWvryJCUN6QU-XNRLFtHj78eiMv_DaP0averGEJelede71vlVyEJfvKaD7of55Y_y3BFlqWARZ3qAhdk0Cze0zu8goz7jkpcWCavQhvbHomokxFF7-sACJpzoiCZprrO-zogsry1eq5VhSCGhqPG9vjocm47Sdpup5nE7EuF87s14ZE8wuB4EkRfxCdHtQEY4vHkF20To_7kFaJXt3ytyg3surT5hsoE-xNcmBXjHlW0beQV_BUT_kmyD4rcXogMFd0YWQhGRr--r9MtWZ-jYs7HUTOGsAKPs3TBqh0uKoQVlZEUfB2R7WDPWKP3QRNnGh-sROrDePWy6eSDlUj83eAoO5Mr5TPCdA5Zi2ovGlTWZki4NZF3kbceH1a8g65sk9FiAwcZ8ryXdwV1XWPAENF9fJVJxgDQQNtyVvsDnYDyi_xFJ34vIbbkcf8Wrols4ViElcb-wp25z6ulm8Bc5c7YMZs2UF0kPmpLDKA-FRNM_GQySrhhnTM7HDHxu0qiu5SfjbL7kmWfhGPcRqA86VdQeYg1Uh9Pno7wqSPVTsYCZdKxkO-HOGiO73XpokGIW05SOM81XTg7KQSU2KaCGtjYkXBYWC4-lyMGogTPVH2dn_aj-2ZpV4wwGtZYfAuGtaPARoV8Lw3IUtRrSq9v7j88xYl7yEiusrLhBI4lXG3qAX4nFV2-YqgrrRTww91gg-Wo4wThL9BBctFeOBCtrYbWYXJMRb7O9eDfZyVyrYXG2l2oV0G5GqPagixmTRAlFJIrJal4c9Fg-dePmTr1Mf2mViDvfPFIL4jt-SevUepx5i5lb_8AKodK2NsGXns8FjviUs1m0UyayTYoaugAgcwVJmumgL69Rl7gynY29nNMM3PvkcHS8sARlRoSA6vJI9nq5vqfTmORgiMOGRH4YE2yuNqw6O3W6xOWJ64UlX8KM84gVHsWZRuuj4LZ7cBsHxXgMaNdDvQAlbHy4saO6bdwY-VksTjzkvQFBoXSO8WB-GyWVx0ncncLiVhXg8Pmcob4fqCo_aSn-GqgxFACnpjX5NEX09_-ea_ibizHtlOOl59FGUfCnIDM8eJDpWExUVCL6l2bhuLAKpI7C3PqUc-Rvt12oIycCb222qugqx9V1YCYbtbSRvyqM2lVYgFrRaL28hwZdI_tvD-96rUHhOb_6zi3dY_biMHviKgRb30Z2JaoDADoYe4Pw3H6ZVK0GinyKvk5OgEwPuDZX6YnxVBxStDIygCSHTsyaZDYc55G3wQg5xMv7Exd2VtU0rV01ewwucBWQLNGDlbYEI-KN-iKpAWhkDEjZE3YdZMlhJk6lTgGLPffIjkDO6UGhemvIxya_Xyy2A_LBbfAkOCYpL0GVO-2M7ZUVTr0F4WCEv1Ww7E3grBgeFfR-ruItxo4QdJgM_az9bXOU4RZpkXUj7DL0dlVpGjX1oVptAQX2v8FctrSo8RciVIkpD6KQ86rY6yn7BTsO11eqU4XQjQ_XJGmysY2gzjyfq2HHCrw7e2TSJQAtl8j2Y7HGPr5kujSdVy80pqluFzbfXtfoGIHDdbYqyv-tdkinfwWbQtozV3HjoILvgEeO_OoEltce5RkSbNI10-WxqKZHXxc6bn2oSA09i8RXHAgfEswoOgcDi_YS6uowoX81xkIto555yHk-dc8jjedIbgOeWh7Cks7ZEDUjMf5vUkyIdR6afhEY6bgz-0mfFAGfnxp-7zaqs-0uPjka4ETq6E2Uy7TNcg8kXtwE0cvXUqYyTw_qt4rWdcqef4hSwUAmIMiIK3t5OJva7Z8q1uW4JZ8LUxUD7fWvj5Lh9kcV6NJSBYq592N98nZOT3HexKFWawk7ZTwd9XYXQcWYCXYlZhWe3Qk7uSQzJ5Hot4QMhc07LayQwXlhHOKl84-OxwB_5NyyWltL3x2osL2GtwpOHngqX_CZlTxJ48kYQXmKnNZMCrrpyzQ7wDgXCtBjAxerOof048CbmLhBPHwIDQvKGYSU9VCfDFla_rubEUNwNtOVSRlYIUjdO18BPsrFkuG3kCNpXT5jfnDxZ8mt0dCtHgsljvriUP6FL8YL-xWMELeXN7shVLoZCeltIr0_IjFU1Gx1BYWOywkG_KLVE3wv8c9K9Q8UmZPJ4O8y6VWTgP6H2pNyKxHSGiz-6mCrc2r1lGDvpmle86QCEmeAwKZRJ9vag44JqCawbuhHZKzo7KvNtnT2I2GyqEPDvj3d93VIs2XJJPlpShSwvP0oe-_pww-dV9IwaIEhst3vxb3oBod1sAyalCoPn7YRPwZ_MasBjh_NKaGTjmRw-8Ev2zcNkbPHGucJfMireDb6hGb5uOw0RBAiODL-bwBJK_ZvqnqmatiTQQ3rELeJvGocnL4V642BbZhixLE2Ur817I2RckYhbZJ9D3lvEj1tWoS-NFSfuZFNUpPRWejUQ0wmyf-ax3mirP4pO5Rq05_NZ62OAfr8CCAEfs3u5LjVYguXCgETAiac_472KEQpVo5Lv7mtl9cYemnT93SL8Jwv7qvnF4zz_GSMRQ4stmZaOQHRzxLi7rcVxtH8-goalgxKwo3Ss8GUM9yCy1cF_2_2dlhCVSk8R1W-DHUyICCfyB5HbocsK_MmtkejD26N9A05SHhA1TsSXp5qXXNCwc8DHLlFpbI6ypbqTsy30_OHxLzpDV7_QGZAIaxfyg22gpLdSxm22KgO2APfTjzCI3vyF9ykzCEbaWBTK00moCOhB0T8hranuufz4sbZ06fV4MXvFuHY4WFIMTJ0gdxKCHDct755xJ8s2m7MsKPD-zgTd3n4wozEGTw8AeZN-tRVXvBv9X1X_PuPB0eRs-gpXtK0-oK3FWv7rTTFJ2MoOBwCqEZdFTTRE6YN97tH51_lWkMjDQmMvez2s2Pvbw1CXolc44SCR7QMZnqzHqjlBvoQL2zF08vI_7VPVlShRY2okDfZ6YW-bf_s9DZdfxFlPx4PLIwWml5T2UKdjqetx1BKF-TqtfTdG2rCusHkj5sPXgw43WjYiT66PE14vGRzVQF-FT4kQXn084qrqxdv2CjaOgKRd_lFZ-St3inj_Z-uhg6SU-aBfa7oXzfCeHqpVt3KqhwBIf56FRF8jbD51NVhHBYlVkud3IImm2yGhBnrE9dLDqELIfMP7MwYBL33EZvGny6zRyxPhXqU8MxfBcMFV1kA6qLtlvVrm6OlgIEYAIZNlv8TYj06Exqcq2592FB3Lyy_CHJ3AIpd89cOP4q1_G4n-GslC4QwI9FmrRh4PtU-BUQhgFV4PTdbDdkkO4VwRLAXBdxjXGlModqCqXESflrcurHqxlwzoe9aqgjb0eDEUmlViLhIUR1Bwu8dTWb6Ct_yMxnC_hDMt91SUm07VIFx42U6USGMGcKi1096fEWl9cVNfHGdYSu-2jPx9JrEdr_iMc6Y-XCh8pLbr2kTjvD_jG898bXjRdjBUiidOJoSpYnwaayo9J2HBuux8JWvRNUVquNyuNYRyRN0ABhgGMTox2fGScKPVzkARvqXBpLn9_jj9DrfuxArP-8VmPOVPchplTH3lUbv-H91Nq7iJzKmsEagxpxR03LMHGcydt7FABALYzjAFPJ2Y9QRQlEmXEFVyz7OOU8hS5V4YneaCg0Qtn4tVk5e-1bjLYlQrpEr5c81im-wF_IwEQDsSiCGCIyOVcmFogOlmhxTi6h18UCXU_8tV8_GTJkvLf_W1sxVK_xq1D1CyppYrpsKSzSa4bonqGUGMduVXFslR9_z8r2qOfj-FjZodh4pF8rSgcuNOr71d61IWqt2TcXpKtDuK6jrBvnFWSoWRYMfiG5_FK8U0Jb5pUESPC5uFY6VttuRLvrqvLVs4gUFR0ul9DQYegSp0vgqoTgOrN7JQrH29zzJM77pVfFOSmxzyo89e00yEDsTfvIEYe4Ir6hbuwgbM7yTDUcZyLzhfvadsyuiPjMBUW8Ck0103c9eMVDvFdDJiO938BnKfmcRmhkbsLdmU30zKxvHB9b9xDddysLlnmA_fPn8oAaItezHq8iyOBW_F8Z-tZeBObcCICDvzxA38NGjxqOu0Pfcf97vGlBh0h4qWmVPRXC6FDwHcMoytfIDfzoKxb-VRW5-IIe55cHXqUO6_P_iX1i-kNS2G150b29wB7KVpjW4A33RrAXwDieSnBuPlqvAs_uOPwC_NlO2j_1hLzfYve-fPcopoFW6cw2GvBKDBZrxtfKE0Rd1Np8YUySx4IB4X1G-jbeE7vd4Gsr7ZM_k6XfF9KLeeZPRdNq7JzctTIOeMIeOPm6ozc-3jWt0ajRAtBYAiV_MX0IDcseWxmCJG7PJenp-P4jM_4CAikqANhoZcmfeqv3dr-nMNqCbT6tQHNekAxMyEyQ-pRv69VH5sVtcZKDxaGMJhOKlZ-fF3gROf52SKOKusHXqsb0yRahobM0_Q5Cp87QQ08UNdxHPx4dA3nGu0AP4_yeT5yxaOKm81mBaSw8pE6L_g-COVFMqJnpAaQvJd_N_7i-EN2N-htbI1MYz7Qes4fLbQNCjpI7WCUf_s6w7ImarLZUWY8D3Sdgrh3k0ecW17kAQ9khvczvUcQOxVhMaS6N3N0ZCelE-z4jFVzr0jTI68TgDrOMNYNJDWvAR5lJ2f9vGWK61E3qplvCfHZCAygXj_4Ap1Qga8oNnazchsUkJ6oIdsUeYDdgpl8BHEeeiLPW9KURFYT7usABIaON6UI3J8yXHRwgtj40ldDflpJnmBoTo-PDLe57jENT_ZSZnPzcBqVnsrdpAg8wZmgiZ_juz8JyPfHUlSSapXl_tiwuPveP1NqBu9qslbS8ex5eJ67UOSHaxBEEMaBAD4g2Ox3hRUgCnSstXVG78E1bbflLaHA_7Q29mSjqUZmJRL6hyQHzBdgOrPKlt_SJkgBf7iE8bBnTZFeP8Hn5_ooRU3Q1kX6v8a861xdXFIOHEzBQPnEcsmsXraMJZVIviFEwjal2L3rWXQMnSO1jm6di9tDk2KV4eygnZqR4y5FqmR5_65wj4acgJXH2rCPz8Kp-nWPsrBbndnSOvtU_Uz2n3gROTnWI3x1JD6qmk2wNXrBSA54zqVmQSVsYXVKzFoBtQuxZORIPR0F9oKsuGlEwPIc-D0="; // embedded encrypted payload (iv + ciphertext)
function b64UrlToUint8Array(s) {
  // base64 urlsafe -> normal base64
  s = s.replace(/-/g, '+').replace(/_/g, '/');
  // add padding
  while (s.length % 4) s += '=';
  const bin = atob(s);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
  return arr;
}

async function deriveKey(password) {
  // SHA-256(password) -> raw 32 bytes used as AES-GCM key
  const pwUtf8 = new TextEncoder().encode(password);
  const hash = await crypto.subtle.digest('SHA-256', pwUtf8);
  // import raw key for AES-GCM
  return crypto.subtle.importKey('raw', hash, {name:'AES-GCM'}, false, ['decrypt']);
}

async function attemptUnlock() {
  const pw = document.getElementById('pw').value || '';
  const status = document.getElementById('status');
  status.textContent = 'Trying...';
  try {
    const key = await deriveKey(pw);
    const token = b64UrlToUint8Array(tokenB64);
    const iv = token.slice(0, 12); // first 12 bytes
    const cipher = token.slice(12); // rest = ciphertext || tag
    const plainBuf = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv }, key, cipher
    );
    const decoded = new TextDecoder().decode(plainBuf);

    // Parse decrypted HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(decoded, 'text/html');

    // Optionally set a <base> so relative URLs in decrypted HTML resolve correctly.
    // By default we set it to the current page location (encrypted_page.html).
    // If your content.html and encrypted_page.html live in different directories,
    // set base.href accordingly (e.g. "data/").
    let baseEl = doc.querySelector('base');
    if (!baseEl) {
      baseEl = doc.createElement('base');
      // Set base to current page. Change this if your content assets are located elsewhere.
      baseEl.href = location.href;
      doc.head.insertBefore(baseEl, doc.head.firstChild);
    }

    // Inject CSS <link> tags from decrypted HTML into real document head
    const links = doc.querySelectorAll('link[rel="stylesheet"]');
    links.forEach(l => {
      try {
        const newLink = document.createElement('link');
        newLink.rel = 'stylesheet';
        // resolve href relative to base
        newLink.href = new URL(l.getAttribute('href'), baseEl.href).href;
        document.head.appendChild(newLink);
      } catch(e) { console.warn('CSS link error', e); }
    });

    // Insert the body content into our content container
    const contentEl = document.getElementById('content');
    // Clear previous content
    contentEl.innerHTML = '';
    // Move nodes from parsed doc.body into the content container
    Array.from(doc.body.childNodes).forEach(node => {
      // For scripts and links we'll handle them separately below, but append now so relative elements appear.
      contentEl.appendChild(document.importNode(node, true));
    });

    // Execute scripts: find <script> tags inside the inserted content and re-create them so they run.
    const insertedScripts = contentEl.querySelectorAll('script');
    for (const oldScript of insertedScripts) {
      const newScript = document.createElement('script');

      if (oldScript.src) {
        // Resolve src relative to base and add cache buster to avoid caching if needed
        const srcResolved = new URL(oldScript.getAttribute('src'), baseEl.href).href;
        newScript.src = srcResolved + '?v=' + Date.now();
        newScript.async = false; // preserve execution order
        // append to body so it loads and executes
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // wait for it to load before continuing to ensure order
        await new Promise((resolve, reject) => {
          newScript.onload = resolve;
          newScript.onerror = () => { console.warn('Script load failed', newScript.src); resolve(); };
        });
      } else {
        // Inline script: copy text and replace so it executes
        newScript.textContent = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // inline executes immediately on insertion
      }
    }

    // Now decrypted content inserted and scripts executed.
    contentEl.style.display = 'block';
    document.getElementById('pw')?.remove();
    document.getElementById('btn')?.remove();
    document.getElementById('status')?.remove();

  } catch (e) {
    console.error(e);
    status.textContent = 'Wrong password or decryption failed.';
  }
}
</script>
</body>
</html>
