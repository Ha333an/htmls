<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Encrypted page</title>
</head>
<body>
  <div>
    <input id="pw" type="password" placeholder="Enter password">
    <button id="btn" onclick="attemptUnlock()">Unlock</button>
  </div>
  <div id="status"></div>
  <div id="content" style="display:none"></div>

<script>
const tokenB64 = "lbn558DgSfP57tdwJW7BTwMIREEfq0wyTD9BIGfKdbR__g9jnu1XL4rbA7KyylwJTCbESZLHnoyYZF5OCA-X_7QcCvaU8tEWdPaSKdsDYPjxdfoJoKvUnJVW-euc2N1yko5E-C6p9TVPTm6pao_DIXTQuCbdSWhpDR7I8VxD96sI6vu3HRrLFIxDJfXLkFSPdC5bHqoWW-r4hc-W3pYgDYtCEkQ40cEwig7MhSJKpVF5oQTK_t-vt6rrQjGxj3nDqL3f9rsxSpdVGLcXGb_7YjQYNwr58CNtd7nbI5e370-i9zLO5ad-QBYMCGLUszGuBC2T1WRwBB_175vVPjnR13OqUOzJ5wGGzBUwGfxu9a4c0X_F8PdGh0ROFsOt2VIfG2Di3Nw_PVmNhZclOcUtgNFahX6ELwNGvESLYLtETE0-EhmAawRr-1u4qaJm8UsmHs90Loend8G79dlnmUpzIDEB6XoVEpxhHXNoqmHdAsz5gyY_43kty2wZFlAP3O4-S1mA6e_qnyVi11HoV4nYuC_xliEX2srsHJI0ImEOzETKyd9xitbSydO1wxY3TrLISfkX3eDs-lC7Mur6gIm7kwL3x18AypU8eP_3MWo2YKZJR3MsPzBYdtnNSLA0NHY6F21unPfpNf3gl1vlAyokOA7TwEcRvOXKhQorYhqaxsB55-Xe7PK7Vp6WSgfaN3OpcOikhtn6QSb5zArKlcR271Pn_PTzk13VTeJpDNA7ABiml_3VEuJjZ6Aem4V7LexncU-Q0mCqDVJjvTDGUhKU9J8f85phX6Jt62SZrbgRgcsAtd3d5DoHZtX10YOyAp70yfHSLBhC9h2ljc7kyPi_a3AP0vdx3a2iodcfeqW5a8j_gW3Tcu4J5QbM00b-gJhKOYoxfoZUN-GD9ktuTOSYohXrHqBt2Kh5i4Z37gagmcSkwaaJhY3vLdu4DqcZ7bYe-eo-PE2SBgSzWaUIcA9Jc8KBUOo72zJ2KFcVmodaCUV4rqsakSiM--hjH6kosZ_BWyI421BMfmN1rgN1amrk6Li7B7CQ_DK08OKcG79uT-jk7To6dyIiCj8DlXGAq00re8UXR0y2vtgOWUlRwqtdeJbP-xBWRDu9_Hdp7G71ElpTlAJ5ctK8D35cY8aApAyIGeLj8dYB6G4vFyDUw-yBrH4Esesql29pvKRpyJlcKi0L1-eesX-tlTmhBGSPYJhVpzZrguLoPdsqdHGoZhgiG9-lTi1Gmelu_AG7lP8NgHoIPOiro3IS5sSTgatWHZP4Kg5PBA8WGE9YV42Yp1Ha9oY0QKnSgd9uwcYdLE-WNxuP0w5lOdyQY4wFcV4EQy55kD8vSyYYHqyJPt8T98iq4eWf6IspT7TFwch1sD0gHQa930SQigdwgJ8piEi2t49lq7lIfMyzcw69EbZ5ylB4mEnx8el41JJpSBdPjNdod86nOMvOY545Sl60g5S0_0eSD573FuSm0EIN8gWoP8Q2-05EJDcgrr2rW_m8LfZ0eK5XWCSwLur8mJX9lBzWSqd4dj6VGYa9OcrQmdgKztWG34J7hhKwvlenIM6btkswUASVkyAGZAbdsAux7D9JM3y5Q-SgWPoAJ7dqZQdk7WFQ3gRjYuR4dUc-4rYOLDfcvzgcbE5f_k7hicN3dKfI5XX21mRy9l867qMx-21etXRHfydDiVk2Lqnbdq0rQpSWOwp0kAKHRhKepGiLhBjPdLu8rIUJYW2GgpFjMa4DRbl8Ut6eKwdlJQRIFZjDSlbbh1k_dK6j1gE03-PHBrQrdFsFlZYyTP8SAO1W3UKsCWEsoNsLu6Ux1uHPUu3K1JuqpPCWeuLRm-2s9h9AUmt9R2grpHp5TnFUTmgf3Su8TgW5qxJwo4ZgAACn3wJCcsNez0zOHrbJfFZQjckNtczkR2QKvke2mhtD0ALQN5_GY918gzYak2MdhxXdOfcFE296o7Zdnl6kSPXS7bhISBtybyu_xO2lX7z5Ee1PTW03h3JN7NO1ZKB54pZiwfb5aKeW_NRuspCYK98Ppv5OFefscI-V-01Fa7IdT9isp7BCUXgHQTldJzddhKfE0zDjAu7Viaqw1YdtohBpExOSooUm4VzbJK-xV_6m8sWoNJylnEUieN89VWKVhjH7dqBQr-Sf4ibiCGB3Z6cnFXxkN4S6v3u50ZosY0IDI4Zbr37LHvR9GRuG9mHsC4JG9AKz2U7HtkVCMy5uCgie_HjmpFwour0Y6tddT1ZKqt0H-aQ9cI2vVi3MEUMYpsoBa5jSfL07ovPTYowqosqVH5RpWC5gLMKJkbU1T_uIXNxmUgyK2jzANJcpXX-hs4Q8GcpTFz-2bk4b5vSPDBiw_CLxmSD_FctYdme7zYEAWGk3CqXR36txtMcj-iUCXeEfZwmCABvmdx33axwKBtv4bQApprjK9AwfGDuzxFCAuhVloao3XgpjaNVCY4JdpA3NQ8ilLUyu-HqGlHwKsqV1cOa9WvvU0iK83IvwEBxHEnyTzosvcng29PPsPRSjpr5V509wFAEwRYkdZqc6fIm-cc9tmX2BSjjeYUASxV3WEITK7WkmSGQGUGIxwUc5S26ktkAs03hWw_yBFofiI6EFH0r1IeoA8jSdI957-pWBDM9aUacSy7aX_6kP13hO2qT-E_BawFlMmCuQplAkDb21UdcvaFtMZ9VU96HKaDvtDgM1f4mDLHJI6Uz2757pyrI4t5voXy2pqywZLkDCUOg4N_cdlqWlAqBEIt0v0mkWs8q1HG5zX1kiVFrUntCePRr-TaSayu1R04ThnUkRnJFN36bSbTOG2eRff8MII6zzJjTD_26l7oOA2ugP8Jhthk5x-VBxNvuJ6tGqXiA9YqxjHmBpi0XGNjjct7voCB30nTwHABi78jPoJ4MmIEDLltfNbiqw9aLz3oMT-GepM93tKOhtd-turr9hKBBLhn0xXNpQRIbrVQTyQ6zdpzoYU8Acoi8uEnZ-UrA44Nuy4Igy4fEsIcTCXU4tAkx9cLTPeif7HL5COSethfdvY6kdKygT5FKbbaOAhPKq3SSCZJBkBJXv5WUrO_1bvCjHlwjd5pdFTp4eCrDJtT6A5WCep1yPHaUbqKvTtY7TvAS4AF67HjodQ1UJp01QPPj8AyVhxYGf7S_UBO9sPcJeYakUw8yd06inTQYrMHM4lUbo2nTEysUaQr5PquBFd6XzF5dHgZH_kztesg5cUCDwOfV190qOT3AzhwmOKkh5NcWwN7LSliuVWFfKZHNG1SJ6RqDm2KYyeM61sz4m5-Z5SukedHA32t_0SxeBED43N1CKkmS7A1lWXEOAa-O4KZP5KC4QVXzSioByFRTB2NC3PoO_reB7tWpyaBEfZWUGxSo2XDy8Z1H3DsQfWljJAUUGDQY9y7kaj8B797SJu8kl_Gu42TsxJD2P-bhrcq0fXD9LjLT4BLh3fSfHFPw2IsG8BcnX63voqOfdtgfBnd-iGbsTeNXVa7D269ZZW38MSLgV8uXau2tpRNF3gGaSswzaOtAi7EX6JQInpEkX8CQWZKeFUOsCRtJKgF2viIAnv-QwUh29SHLU5XNlXmf6S4LNXki7iZoF2m_qME6UHFbqvy54eCYvsfZ3kUpnv1wypNimNxQ3ma4LuODEZW6KcDRypbKlImFqgWwDxNTHwqBy4IiMtFQ8YMEbfjZyWFCbOjZmmZMaaKV1LSTZ2DStYgcJCM0aYNe9OiWgVAYEC1OeoOcicH8Aq113Tyuc286RMpNcM09XZVv5DjZVaj5ehQJElLliaM0hSEZYEaWDn96EYuF0nJDIabZQmK0QNzS-hLDm0-_2LvHWRQjx-Fnr8HBo4y4zKpoae6Q7EBJiQLNB2DAmphAO-hPSqr48ODjOnyakGpXNLfUx6Nm8FkExsKQyNLiJcYKR4ePscQIBxrD9JZLFlUKi4eJIjMKUGp5wS86qO6Eg7WXXAGfAn-7XcCc0y7nOmcJBljuJZ9AkDSBvOQhG_W705-0eVQ5Zbbj4iedW8odx-UcSEeTMnGI-dK6t6X7W5KWWN1O6rDt6Ixm1_zfa9Rvg3HZK0eWnWAG2MM0HXQNuByhEhnWGR-LNwgkxaElqqZ6Y1_rxAcwIUUj-p2c9GITrfjnJGI8eayPCdjAornCbBb78jCf6G526jNaKKtRYT-y42GUcThPQYsaEVeCg_eFSPrx5Qfj_qu3EWQQNzG8kTDB_Wd3HyU_DozU7DmaoBLQCu1ici2hWgqu3eBNAZS6ZL3cKcLYlfIj-LrHNR1t5ltEJh3GLZxuJ2cmjwj7id0ywqX6uYJUL4CD5scvVHqS3ur3qQRSOQ6q9OdX5kf7hJYSlQhqN1tC0Mgm7TfWQMc19YH3uGtjSS6q-aG77dVzJClDVvTqaxaABy9eotgDDgcLVGpmG0BRvV-V2nO-cdqS2fb5ZfPqNFkj4hMCt0kScAx3yPmTCbd86rIYpPNXcDPlT78dHTRo6E-NB2K3Bbb-15DQI6VkV3ddW_T8WI3pHU66G-2a-2x0t3S1jzPlrtstTWlfQCmAyGjBGEkUpH1ya4WzWqFbnHKFZtqOkb-G1LgA2YSKzcByNSZWAnjEnXZQ3AmzgwLNUDRi1Yltsm9zoKz_4SEUARbd446JbeQaCaPOK5Ek654mAM1Y3kk8hd7gi1q5oD-HVF6Lw92z9FetiCVIOEKaNacaiR18-eKu0bzIHzvP0ob73auLHxhoRU9TPDflxAbjHHhreCPblRBGU4GlBcQqT6SnbrZoDopw4BRMoosvj25CGXTD08g_A-Hy28GNjlGtVet3LXQBtSTQXUWyMR46nQ78sgmdMsu2RZM4NLrevnRECRIt89KnyTi_yq9v6d-w7hDgRL5VhY4c6yVPBlNlYBXjKC4oE6CFwqwxS3iWrrpmTIkkH5Y3j4ZeclmSTfrpaYzZuNpO6u9LoPYfOHskfLp8DVxUoqT-LoxDmVPzy_lLuAOL8sD1kU9LzEFyvTWv-H8UtamP5LbfDWXCL4DDRC6lD4-yoTVCrXWBX2wPE-dR3K56Pr44mPZZLh9c6Kr-T2Etes7xUDvMJbRoZsrxeoDVAWS5c6P1NnTPKnXmWhhAcKtTG7uMYXm3_MVxB9S7jCZOON3pby4ivZMaCy_FqIsvMaxgt_pzY_gCIyS5rnBGKBIjqd_eFX6kenmalo2JxUHu_zu-Yc0TXAEWgh4iIsRHo-UoZjddyTt4jFYnXGlkEEI7RF-zFLjebtZxd2sqPf-BNLiiKK6gHpUQIMFy7HVF_P8IKqd7lT5Q4kJ8IIL52zcYEFmoC6CBMW9YThJ-So-dtvgLd3mO0XHXlrxflEc36DNjSOBcgW5ZuE26n-yzIDeKz48eMWSgnfv0Uut2d6uEK1lD5Cd4dRZ79REQ0ocBgW-9Yo6hkhm-6wsv5cIVWuNI6Meko_ids8iXcTTo7pDhKVe7eHN5YrpH3bSOdUvchtm812vVm5MzCvw_Y4nrChXj9soYn3lgMUMSiphImAEs-hRhU19YH_g=="; // embedded encrypted payload (iv + ciphertext)
function b64UrlToUint8Array(s) {
  // base64 urlsafe -> normal base64
  s = s.replace(/-/g, '+').replace(/_/g, '/');
  // add padding
  while (s.length % 4) s += '=';
  const bin = atob(s);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
  return arr;
}

async function deriveKey(password) {
  // SHA-256(password) -> raw 32 bytes used as AES-GCM key
  const pwUtf8 = new TextEncoder().encode(password);
  const hash = await crypto.subtle.digest('SHA-256', pwUtf8);
  // import raw key for AES-GCM
  return crypto.subtle.importKey('raw', hash, {name:'AES-GCM'}, false, ['decrypt']);
}

async function attemptUnlock() {
  const pw = document.getElementById('pw').value || '';
  const status = document.getElementById('status');
  status.textContent = 'Trying...';
  try {
    const key = await deriveKey(pw);
    const token = b64UrlToUint8Array(tokenB64);
    const iv = token.slice(0, 12); // first 12 bytes
    const cipher = token.slice(12); // rest = ciphertext || tag
    const plainBuf = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv }, key, cipher
    );
    const decoded = new TextDecoder().decode(plainBuf);

    // Parse decrypted HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(decoded, 'text/html');

    // Optionally set a <base> so relative URLs in decrypted HTML resolve correctly.
    // By default we set it to the current page location (encrypted_page.html).
    // If your content.html and encrypted_page.html live in different directories,
    // set base.href accordingly (e.g. "data/").
    let baseEl = doc.querySelector('base');
    if (!baseEl) {
      baseEl = doc.createElement('base');
      // Set base to current page. Change this if your content assets are located elsewhere.
      baseEl.href = location.href;
      doc.head.insertBefore(baseEl, doc.head.firstChild);
    }

    // Inject CSS <link> tags from decrypted HTML into real document head
    const links = doc.querySelectorAll('link[rel="stylesheet"]');
    links.forEach(l => {
      try {
        const newLink = document.createElement('link');
        newLink.rel = 'stylesheet';
        // resolve href relative to base
        newLink.href = new URL(l.getAttribute('href'), baseEl.href).href;
        document.head.appendChild(newLink);
      } catch(e) { console.warn('CSS link error', e); }
    });

    // Insert the body content into our content container
    const contentEl = document.getElementById('content');
    // Clear previous content
    contentEl.innerHTML = '';
    // Move nodes from parsed doc.body into the content container
    Array.from(doc.body.childNodes).forEach(node => {
      // For scripts and links we'll handle them separately below, but append now so relative elements appear.
      contentEl.appendChild(document.importNode(node, true));
    });

    // Execute scripts: find <script> tags inside the inserted content and re-create them so they run.
    const insertedScripts = contentEl.querySelectorAll('script');
    for (const oldScript of insertedScripts) {
      const newScript = document.createElement('script');

      if (oldScript.src) {
        // Resolve src relative to base and add cache buster to avoid caching if needed
        const srcResolved = new URL(oldScript.getAttribute('src'), baseEl.href).href;
        newScript.src = srcResolved + '?v=' + Date.now();
        newScript.async = false; // preserve execution order
        // append to body so it loads and executes
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // wait for it to load before continuing to ensure order
        await new Promise((resolve, reject) => {
          newScript.onload = resolve;
          newScript.onerror = () => { console.warn('Script load failed', newScript.src); resolve(); };
        });
      } else {
        // Inline script: copy text and replace so it executes
        newScript.textContent = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
        // inline executes immediately on insertion
      }
    }

    // Now decrypted content inserted and scripts executed.
    contentEl.style.display = 'block';
    document.getElementById('pw')?.remove();
    document.getElementById('btn')?.remove();
    document.getElementById('status')?.remove();

  } catch (e) {
    console.error(e);
    status.textContent = 'Wrong password or decryption failed.';
  }
}
</script>
</body>
</html>
